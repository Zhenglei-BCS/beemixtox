---
title: "Manuscript Preparation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{msPAF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=T,
  fig.width = 12,
  fig.height = 10
)
library(pander)
panderOptions("table.split.table",Inf)
```



- Among the  616795 entries, 67155 are Metal concentration measurements. After subtracting the metal reference concentration, 11013 result Mean values are negative, 6723 result max values are negative, they are modified to be 0. 

```
> table(chemclass[,c("class","SVHC")])
               SVHC
class           SVHC
  Banned_Listed   22
  Current_Use      0
  Metal            5


  
> table(chemclass[,c("class","Candidate.SVHC")])
               Candidate.SVHC
class           Candidate.SVHC
  Banned_Listed             26
  Current_Use                0
  Metal                      3

```

```{r}
chemclass%>% filter(SVHC=="SVHC" & Candidate.SVHC=="Candidate.SVHC") %>% pander::pander(.)
```


```{r}
chemclass%>% filter(SVHC=="SVHC" & is.na(Candidate.SVHC)) %>% pander::pander(.)
```


```{r}
chemclass%>% filter(is.na(SVHC) & Candidate.SVHC=="Candidate.SVHC") %>% pander::pander(.)
```


```
> summary((Data.AggBySiteID.3a$HC05.Chronic[!is.na(Data.AggBySiteID.3a$PNEC)]/Data.AggBySiteID.3a$PNEC[!is.na(Data.AggBySiteID.3a$PNEC)]))
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
 0.01035  0.04000  0.26050  0.91362  0.95287 12.27785 
```


## Changes Aug. 10

- [x] New changes required to be implemented
  - [x] LOQ.T1 = Values set to LOQ (not 1/2 LOQ)
  - [x] New analysis categories
        - All
        - All.Refined.Metals&PAHs
        - All.Excluding.Metals&PAHs
        - Current.Use
  - [x] New files to be use
  - [x] Revised CAS classifications
  - [x] Refined metals (background concentrations)
  - [x] Refine PAHs (PNECs)
 
- [ ] Changes to Figures/Tables:
  - [x] Table 1 (Acute and chronic.csv) add new categories
  - [x] Figure 1. 
    - [x] Check N CAS, seems not be correct.
    - [x] Remove LOQ.T1
    - [x] First row acute data
    - [x] Second row chronic data
    - [x] Cases to show: 
        - [x] All (refined) | All. Excluding Metals & PAHs | Current use
  - [x] Figure 2. 
    - [x] Still thinking what to do with this Figure. For now: All (refined)| Current use. LOQ.T0|LOQ.T1. HI vs N.Measured, and HI vs N.Detected
  - [ ] Figure 3. All (refined) | Exclude | Current use. LOQ.T0, LOQ.T1 as SM Figure
  - [ ] Figure 4a,b. All (refined). LOQ.T0


## Reproducible R Script and Output

- take only Lake water body and River water body data.
- SSD data from L.Posthuma SSDs
- Keep only "total water" to avoid replications
- remove rows with Missing observed value ("O" category) and unreliable meta info ("U" category).
- Remove 85 rows with measurement has been confirmed by country to be taken from a highly polluted area 



- LOQ.type = "LOQ.T0", The values that are below LOQ are set to 0 $\mu$g/L.
- Exclude priority pollutants entries and metals.
- Note here we can make it a parameterized report or using functions if necessary. 




- use monitoring site, Year as grouping variables to calculated the number of measured, the number of detected, and the ratio as detection rate. 
- left join the aggregated dataset with SSD information with CAS being the identifier.

- [ ] check code against Ismael's. 

## Table for the Manuscript

- CEFIC-MIAT decision tree table (Valloton &Proce 2016) 
- Group I: Risk driven by single chemicals HI >1 & MaxHQ >1
- Group II:No concern HI < 1, MaxHQ < 1
- Group IIIA: Mixtures concern driven by 1 or 2 chemicals. HI>1 & Max HI <1 & MCR < 2
- Group IIIB: Mixture risk. HI > 1 & MaxHQ < 1 & MCR >2

Table 1. CEFIC-MIAT Table 

- Include only AF 1 (Do we want to include other Afs?) 
- Chronic, same for Acute (for SM Materials) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_None", "Excluded_Metals", "Current_Use") 
- Generate identical Table for Acute for SM. 



## Figures for the Manuscript


```{r}
library(beemixtox)
library(quantreg)
library(tidyverse)
data("Data.AggBySiteID.2")
tmp1 <- Data.AggBySiteID.2 %>% group_by(Site.Year) %>% summarise(N=length(Site.Year)) %>% mutate(n1=mean(N))
data("Data.SSD")
data("chemclass")
CAS.SSD = unique(Data.AggBySiteID.2$CAS)[unique(Data.AggBySiteID.2$CAS)%in%as.character(unique(Data.SSD$CAS.))]
Data.SSD.1 = Data.SSD[Data.SSD$CAS.%in%CAS.SSD,]; Data.SSD.1 = droplevels(Data.SSD.1)

```

### Figure 1

Figure 1. log10(HI)-MCR Plots. Faceted plot (2x3). 

Chronic, same for Acute (for SM Materials) 

LOQ.type = c("LOQ.T0", "LOQ.T1") 

Exclusion.CAS = c("Excluded_None", "Excluded_Metals", "Current_Use") 

To do: 

- [x] Check the function defining the regions (Group II, Group I, Group IIIa, Group IIIb) 

- [x] Add annotation with the name of the group and % of samples 

- [x] Add annotation with the N.Site_Year, N.CAS 

- [ ] Question about N-CAS! Measured in this particular dataset or detected? Or in terms of all sites.  

- [x] Add colored sharing to the no concern group 
- [ ] Table 13: Substances driving the cumulative risks for each of the mixture groups in the Rhine dataset under the more realistic scenario

**Note that 1808 site.year has HI of 0, around 15.5 %**




```{r}
Res <- getResData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0","LOQ.T1"),
            Exclusion.CAS = c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use"),Data.SSD.1,useAllMax=T)
Res <- getResData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0","LOQ.T1"),
            Exclusion.CAS = c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use"),Data.SSD.1,useAllMean=T)

# # A tibble: 94,374 x 31
```



- save the table first before the plot

Table 1. CEFIC-MIAT Table 

- Include only AF 1 (Do we want to include other Afs?) 
- Chronic, same for Acute (for SM Materials) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_None", "Excluded_Metals", "Current_Use") 
- Generate identical Table for Acute for SM. 

```{r}
N_CAS_Site_tmp <- Res %>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(N.Site=length(unique(monitoringSiteIdentifier)),N.Sample=length(monitoringSiteIdentifier)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use")))
table_chronic <- Res%>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(monitoringSiteIdentifier))%>% ungroup %>% left_join(N_CAS_Site_tmp[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
if(interactive()){
  write.csv(table_chronic,file="inst/manuscript_additional/table_chronic.csv")
}

```


```{r}
table_chronic%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.)
```


```{r}
table_acute <- Res%>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Acute) %>% summarise(N=length(monitoringSiteIdentifier))%>% ungroup %>% left_join(N_CAS_Site_tmp[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
if(interactive()){
  write.csv(table_acute,file="inst/manuscript_additional/table_acute.csv")
}
```

```{r}
table_acute%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.)
```


## Figure 1

```{r}
recting <- rbind(data.frame(xmin=-Inf,xmax=1,ymin=-Inf,ymax=Inf,col="green"),
                 data.frame(xmin=1,xmax=Inf,ymin=0,ymax=2,col="red"),
                  data.frame(xmin=1,xmax=Inf,ymin=2,ymax=Inf,col="yellow"))
```



```{r}
sum(Res$HI_Acute==0 & Res$Exclusion.CAS=="Excluded_None" & Res$LOQ.type=="LOQ.T0")
sum(Res$HI_Acute==0 & Res$Exclusion.CAS=="Excluded_None" & Res$LOQ.type=="LOQ.T1")

df <- data.frame(x=1e-6,y=9)

N_CAS_Site <- Res %>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(N.Site=length(unique(monitoringSiteIdentifier)),N.Sample=length(monitoringSiteIdentifier)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use")))
N.CAS <- sapply(c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use"),function(x)getNcas(x,chemclass))
N_CAS_Site$N.CAS <- rep(N.CAS[unique(N_CAS_Site$Exclusion.CAS)],2)
N_CAS_Site <- data.frame(df,N_CAS_Site)

Nclass <- Res %>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Acute) %>% summarise(N=length(monitoringSiteIdentifier))%>% left_join(N_CAS_Site[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)

Nclass1 <- Nclass %>% filter(Group_AF1_Acute=="IIIA" | Group_AF1_Acute =="IIIB")%>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(Perc=sum(Perc)) %>% mutate(Group="III")

Nclass <- rbind(Nclass1,Nclass[,c("LOQ.type","Exclusion.CAS","Perc","Group_AF1_Acute")]%>%rename(Group=Group_AF1_Acute)%>%filter(Group=="I"|Group=="II"))

df1 <- data.frame(x=1e-6,y=7,Label="No concern",Group="II")
df1 <- rbind(df1,data.frame(x=20,y=5,Label="Single Substance Risk",Group="I"))
df1 <- rbind(df1,data.frame(x=5,y=10,Label="Multiple Chemicals Risk",Group="III"))
Nclass <- Nclass %>% left_join(df1)
```



```{r}
#ggplot(Res,aes(x=log10(HI_Acute),y=MCR.HC50.Acute.EC50))+geom_point()+geom_text(data=df,aes(x=x,y=y),label=paste0("N.Site = ",10,"\nN.CAS = ",5))+facet_grid(LOQ.type~Exclusion.CAS)
Res_1 <- Res %>% filter(LOQ.type=="LOQ.T0" & Exclusion.CAS != "Excluded_None") %>% droplevels(.)
N_CAS_Site_1 <- N_CAS_Site%>% filter(LOQ.type=="LOQ.T0" & Exclusion.CAS != "Excluded_None")%>% droplevels(.)
Nclass_1 <- Nclass%>% filter(LOQ.type=="LOQ.T0" & Exclusion.CAS != "Excluded_None")%>% droplevels(.)

ggplot(Res_1,aes(x=HI_Acute,y=MCR.HC50.Acute.EC50))+geom_point(aes(col=Group_AF1_Acute))+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass_1,aes(x=x,y=y,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust="inward") +scale_x_log10()+geom_vline(xintercept = 1,col="blue")+geom_hline(yintercept = 2,col="blue")+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y),col="blue")+theme(legend.position = "bottom")
# geom_rect(data=recting,aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax,fill=col))
# ggplot(data.frame(x=1:10,y=1:10),aes(x=x,y=y))+geom_point()+scale_x_log10()+ geom_line() 
if(interactive()){
  ggsave("inst/manuscript_additional/Figure1-Acute.png",width = 15,height=8,dpi=300)
}
```


- here we want to combine the acute and chronic results

```{r}
N_CAS_Site_Acute <- N_CAS_Site_1 %>% mutate(test="Acute")
Nclass_Acute <- Nclass_1 %>% mutate(test="Acute")
Res_Acute <- Res_1 %>% mutate(MCR=MCR.HC50.Acute.EC50,HI=HI_Acute,Group_AF1=Group_AF1_Acute)%>% mutate(test="Acute")

```


```{r}
N_CAS_Site$y <- 8


Nclass <- Res %>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(monitoringSiteIdentifier))%>% left_join(N_CAS_Site[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
Nclass1 <- Nclass %>% filter(Group_AF1_Chronic=="IIIA" | Group_AF1_Chronic =="IIIB")%>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(Perc=sum(Perc)) %>% mutate(Group="III")

Nclass <- rbind(Nclass1,Nclass[,c("LOQ.type","Exclusion.CAS","Perc","Group_AF1_Chronic")]%>%rename(Group=Group_AF1_Chronic)%>%filter(Group=="I"|Group=="II"))

df1 <- data.frame(x=1e-6,y=4,Label="No concern",Group="II")
df1 <- rbind(df1,data.frame(x=50,y=5,Label="Single Substance Risk",Group="I"))
df1 <- rbind(df1,data.frame(x=5,y=9,Label="Multiple Chemicals Risk",Group="III"))
Nclass <- Nclass %>% left_join(df1)
Nclass_1 <- Nclass%>% filter(LOQ.type=="LOQ.T0" & Exclusion.CAS != "Excluded_None")%>% droplevels(.)

ggplot(Res_1,aes(x=HI_Chronic,y=MCR.HC05.Chronic.NOEC))+geom_point(aes(col=Group_AF1_Chronic))+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass_1,aes(x=x,y=y,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust="inward")  +scale_x_log10()+geom_vline(xintercept = 1)+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y))+scale_y_continuous(limits=(c(1,10)),expand = c(0,0))+theme(legend.position = "bottom")

# ggplot(Res_1,aes(x=HI_Chronic,y=MCR.HC05.Chronic.NOEC))+geom_point(aes(col=Group_AF1_Chronic))+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass_1,aes(x=x,y=y,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust="inward")  +scale_x_log10()+geom_vline(xintercept = 1)+facet_grid(Exclusion.CAS~LOQ.type,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y))+scale_y_continuous(limits=(c(1,10)),expand = c(0,0))+theme(legend.position = "bottom")

if(interactive()){
  ggsave("inst/manuscript_additional/Figure1-Chronic.png",width = 15,height=8,dpi=300)
}
```


```{r}
N_CAS_Site_Chronic <- N_CAS_Site_1 %>% mutate(test="Chronic")
Nclass_Chronic <- Nclass_1 %>% mutate(test="Chronic")
Res_Chronic <- Res_1 %>% mutate(MCR=MCR.HC05.Chronic.NOEC,HI=HI_Chronic,Group_AF1=Group_AF1_Chronic)%>% mutate(test="Chronic")

```


```{r}
N_CAS_Site_1 <- rbind(N_CAS_Site_Acute,N_CAS_Site_Chronic)
 Nclass_1 <- rbind(Nclass_Acute,Nclass_Chronic)
 Res_1 <- rbind(Res_Acute,Res_Chronic)
 # Res_1$Group_AF1 <- NA
 # Res_1$Group_AF1[Res_1$test=="Acute"] <- Res_1$Group_AF1_Acute[Res_1$test=="Acute"]
 # Res_1$Group_AF1[Res_1$test=="Chronic"] <- Res_1$Group_AF1_Chronic[Res_1$test=="Chronic"]
 Res_1 <- Res_1 %>% rename(Group=Group_AF1)
 ggplot(Res_1,aes(x=HI,y=MCR))+geom_point(aes(col=Group))+geom_text(data=N_CAS_Site_1,aes(x=x,y=y*0.95,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass_1,aes(x=x,y=y*0.8,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust=1,hjust=0.8)  +scale_x_log10()+geom_vline(xintercept = 1)+facet_grid(test~Exclusion.CAS,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y))+scale_y_continuous(limits=(c(1,10)),expand = c(0,0))+theme(legend.position = "bottom",strip.text.x = element_text(size =12),strip.text.y = element_text(size = 12))
ggsave("inst/manuscript_additional/Figure1-final.png",width = 9,height=6,dpi=300)
if(interactive()){
  ggsave("inst/manuscript_additional/Figure1.png",width = 15,height=8,dpi=300)
}
```



### Figure 2

Figure 2.  log10(HI)-N.Chemicals Measured & Detected. Faceted plot (2x4?). 

Chronic, same for Acute (for SM Materials) 

LOQ.type = c("LOQ.T0", "LOQ.T1") 

Exclusion.CAS = c("Excluded_None" (for N.Measured), "Excluded_None", "Excluded_Metals", "Current_Use") 

To do: 

- [x] Add annotation with the name of the group and % of samples (only Group II, no concern) 
- [x] Add annotation with the N.Site_Year, N.CAS 
- [x] Add colored sharing to the no concern group 
- [x] superpose boxplots


```{r}
df <- data.frame(x=200,y=1e-6)

tmp <- Res[,c("HI_Acute","HI_Chronic","Ndetected","Nmeasured","LOQ.type","Exclusion.CAS")]


# tmp <- tmp %>% pivot_longer(cols = c(Ndetected,Nmeasured),values_to="N",names_to="Ntype") %>% filter(Ntype=="Ndetected"|(Ntype=="Nmeasured" & Exclusion.CAS=="Excluded_None"))
tmp <- tmp %>% pivot_longer(cols = c(Ndetected,Nmeasured),values_to="N",names_to="Ntype") # %>% 
tmp$Exclusion.CAS <- factor(tmp$Exclusion.CAS,levels=(c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use")))
tmp$Ntype<- factor(tmp$Ntype,levels=(c("Nmeasured","Ndetected")))

sumtmp <- tmp %>% group_by(LOQ.type,Exclusion.CAS,Ntype)%>%summarise(Perc=sum(HI_Acute<1)/length(HI_Acute)*100,x1=max(N)) 
sumtmp <- cbind(df,sumtmp)
N_CAS_Site$x <- sumtmp$x[1]
N_CAS_Site$y <- 1e-03
N_CAS_Site$Ntype <- "Ndetected"
# N_CAS_Site <- rbind(N_CAS_Site,N_CAS_Site%>%filter(Exclusion.CAS=="Excluded_None") %>% mutate(Ntype="Nmeasured"))

N_CAS_Site_1 <- rbind(N_CAS_Site,N_CAS_Site%>% mutate(Ntype="Nmeasured"))

N_CAS_Site_1$Ntype<- factor(N_CAS_Site_1$Ntype,levels=(c("Nmeasured","Ndetected")))
N_CAS_Site_1$Exclusion.CAS <- factor(N_CAS_Site_1$Exclusion.CAS,levels=(c("Excluded_None","Refined_Metals_PAH","Excluded_Metals","Current_Use")))
N_CAS_Site_1 <- N_CAS_Site_1%>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")%>% droplevels(.)

tmp_1 <- tmp %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")
N_CAS_Site_1  <- N_CAS_Site_1 %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")
sumtmp_1 <- sumtmp %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")

ggplot(tmp_1,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(Ntype~LOQ.type+Exclusion.CAS)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)
if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Acute.png",width = 12,height=8,dpi=300)
}


ggplot(tmp_1,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(Ntype~LOQ.type+Exclusion.CAS)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)+scale_x_log10()
if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Acute-logxy.png",width = 12,height=8,dpi=300)
}


N_CAS_Site_1<- left_join(N_CAS_Site_1,sumtmp_1[,-c(1,2)])

# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"]*0.7
# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0" & N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0"& N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"]*0.7
N_CAS_Site_1$y <- 0.000005
sumtmp_1$y <- 1e-07

#sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"]*0.7
#sumtmp[sumtmp$LOQ.type=="LOQ.T0" & sumtmp$Exclusion.CAS=="Excluded_None","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T0"& sumtmp$Exclusion.CAS=="Excluded_None","x1"]*0.7


ggplot(tmp_1,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_wrap(Ntype~Exclusion.CAS+LOQ.type,scales="free_x",ncol=4)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red",formula=y ~ qss(x, lambda = 3))+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x1,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x1,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)),hjust=1)#+coord_cartesian(clip = 'off')




if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Acute-free_x.png",width = 12,height=8,dpi=300)
}

```

**Figure 2 Chronic**

```{r}
sumtmp <- tmp %>% group_by(LOQ.type,Exclusion.CAS,Ntype)%>%summarise(Perc=sum(HI_Chronic<1)/length(HI_Chronic)*100,x1=max(N)) 
sumtmp <- cbind(df,sumtmp)

sumtmp_1 <- sumtmp %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")
tmp_1 <- tmp %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")
N_CAS_Site_1  <- N_CAS_Site_1 %>% filter(Exclusion.CAS=="Excluded_Metals"| Exclusion.CAS =="Current_Use")


N_CAS_Site_1<- left_join(N_CAS_Site_1,sumtmp_1[,-c(1,2)])
N_CAS_Site_1$x <- 200
N_CAS_Site_1$y <- 0.000005
sumtmp_1$y <- 1e-07


ggplot(tmp_1,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(Ntype~LOQ.type+Exclusion.CAS)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)
#local({  Asym <- 10; lrc <- -4; c0 <- 43
#  SSasympOff(tmp_1, Asym, lrc, c0) # response and gradient
#})
#fm1 <- nls(HI_Chronic ~ SSasympOff(N, Asym, lrc, c0), data =subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals"))

library(drc)
model <- drm(HI_Chronic ~ N, fct = AR.3(),data =subset(tmp_1,Ntype=="Ndetected" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals"))
summary(model)
plot(model)
predict(model,data.frame(N=78))

model <- drm(HI_Chronic ~ N, fct = AR.3(),data =subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals"))
summary(model)
plot(model)
predict(model,data.frame(N=169))


model1 <- rqss(HI_Chronic ~ qss(N,constraint = "VI"),data =subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals"))
summary(model1)
predict(model1,data.frame(N=max(subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals")$N)))


model2 <- rqss(HI_Chronic ~ qss(N,constraint = "VI"),data =subset(tmp_1,Ntype=="Ndetected" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals"))
summary(model2)
predict(model2,data.frame(N=max(subset(tmp_1,Ntype=="Ndetected" & LOQ.type=="LOQ.T0" & Exclusion.CAS=="Excluded_Metals")$N)))
predict(model2,data.frame(N=70))
model <- rqss(HI_Chronic ~ qss(N),data =subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T1" & Exclusion.CAS=="Excluded_Metals"))
summary(model)
predict(model,data.frame(N=max(subset(tmp_1,Ntype=="Nmeasured" & LOQ.type=="LOQ.T1" & Exclusion.CAS=="Excluded_Metals")$N)))


model <- rqss(HI_Chronic ~ qss(N),data =subset(tmp_1,Ntype=="Ndetected" & LOQ.type=="LOQ.T1" & Exclusion.CAS=="Excluded_Metals"))
summary(model)
predict(model,data.frame(N=max(subset(tmp_1,Ntype=="Ndetected" & LOQ.type=="LOQ.T1" & Exclusion.CAS=="Excluded_Metals")$N)))

if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Chronic.png",width = 12,height=8,dpi=300)
}


ggplot(tmp_1,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(Ntype~LOQ.type+Exclusion.CAS)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)+scale_x_log10()
if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Chronic-logxy.png",width = 12,height=8,dpi=300)
}



N_CAS_Site_1$y <- 0.00005
sumtmp_1$y <- 1e-07



ggplot(tmp_1,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_wrap(Ntype~Exclusion.CAS+LOQ.type,scales="free_x",ncol=4)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red",formula=y ~ qss(x, lambda = 3))+scale_y_log10()+geom_text(data=sumtmp_1,aes(x=x1,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x1,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)),hjust=1)+theme(strip.text.x = element_text(size =12))#+coord_cartesian(clip = 'off')


if(interactive()){
  ggsave("inst/manuscript_additional/Figure2-Chronic_free_x.png",width = 9,height=6,dpi=300)
}

```


### Figure 3

Figure 3.  
- HI vs Station (Stacked bar plot) HI by 1th, 2th, 3th, and all Other components (for Station_Year with HI > 0.1) 
- Boxplot (inside the Stacked bar plot) with the % Risk by 1th, 2th, 3th, all other component. 
- Faceted plot (2x2) 
- Chronic, same for Acute (for SM Materials) 

- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals", "Current_Use") 

- [x] superpose boxplot


*check the main drivers! breakdown the HI into driver 1, 2, 3 and other.*


**Get Driver Data for Plotting the Figures**

```{r}
driverdata <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0"), Exclusion.CAS = c("Refined_Metals_PAH", "Excluded_Metals","Current_Use"), Data.SSD.1,threshold = 1)
```

- note that only ALl with refined Metals and PAHs would have Acute Driver data results. As we have defined the threshold being HI greater than 1. 

```{r}

sumdriver <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test,Component) %>% summarise(HQ=sum(HQ)) %>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test) %>% mutate(sumHQ=sum(HQ),Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

ggplot(sumdriver,aes(x=Component,y=Perc))+geom_bar(aes(fill=Component),stat="identity")+facet_grid(LOQ.type~Exclusion.CAS+test)+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.1))



driverdata1 <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test) %>% nest()%>% 
  mutate(data=purrr::map(data,function(df){
    df1<- df%>%group_by(Site.Year,monitoringSiteIdentifier,phenomenonTimeReferenceYear,HI) %>% nest()
    
    df <- df1[order(df1$HI,decreasing = T),]%>% add_column(x=1:nrow(df1))%>%unnest(cols = c(data))%>% ungroup
    return(df)}))%>%
  unnest(cols = c(data))%>%mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

driverdata1 <- driverdata1 %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Refined_Metals_PAH","Excluded_Metals","Current_Use")))

nsample <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Refined_Metals_PAH","Excluded_Metals","Current_Use")))


ggplot(driverdata1%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(Exclusion.CAS~.,scale="free",ncol=1)+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)+ylab("HI")+theme(legend.position = "bottom")+geom_hline(yintercept = 1)


ggplot(driverdata1%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(Exclusion.CAS~.,scale="free",ncol=3)+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)+ylab("HI")+theme(legend.position = "bottom")+geom_hline(yintercept = 1)+xlab("")



 # annotation_custom(grob = ggplotGrob(an_sub), 
 #                          xmin = 5400000, xmax = 6600000, 
 #                          ymin = 2950000, ymax = 4150000)
# - https://ikashnitsky.github.io/2017/subplots-in-maps/



if(interactive()){
  ggsave("inst/manuscript_additional/Figure3-Chronic.png",width = 12,height=5,dpi=300)
}



```

-[ ] take the same stations as in Excluded Metals.

```{r}
site.year <- driverdata%>%filter(Exclusion.CAS=="Excluded_Metals",test=="Chronic") %>% group_by(LOQ.type)%>% nest()%>%mutate(sy=map(data,function(df)unique(df$Site.Year)))
## extract driver data with the same site.year.

currentdat <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0"),
Exclusion.CAS = c("Current_Use"),Data.SSD.1, threshold=0.1)
currentdat <- currentdat %>% filter(test=="Chronic")
tmp1 <- currentdat %>% filter(LOQ.type=="LOQ.T0") %>% filter(Site.Year %in% site.year$sy[[1]])
# tmp2 <- currentdat %>% filter(LOQ.type=="LOQ.T1") %>% filter(Site.Year %in% site.year$sy[[2]])
# currentdat1 <- rbind(tmp1,tmp2)%>%group_by(LOQ.type) %>% nest()%>% mutate(data=purrr::map(data,function(df){
#   df1<- df%>%group_by(Site.Year,monitoringSiteIdentifier,phenomenonTimeReferenceYear,HI) %>% nest()
#   df <- df1[order(df1$HI,decreasing = T),]%>% add_column(x=1:nrow(df1))%>%unnest(cols = c(data))%>% ungroup
#   return(df)}))%>%unnest(cols = c(data))%>%mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

currentdat1 <- tmp1 %>%group_by(LOQ.type) %>% nest()%>% mutate(data=purrr::map(data,function(df){
  df1<- df%>%group_by(Site.Year,monitoringSiteIdentifier,phenomenonTimeReferenceYear,HI) %>% nest()
  df <- df1[order(df1$HI,decreasing = T),]%>% add_column(x=1:nrow(df1))%>%unnest(cols = c(data))%>% ungroup
  return(df)}))%>%unnest(cols = c(data))%>%mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))
```


- Generate Table 13: Substances driving the cumulative risks for each of the mixture groups in the Rhine dataset under the more realistic scenario 
- Limit the chemical presented in the Table to those that occur in at least 5% of all samples with HI>1

```{r}
driverdata1 %>% left_join(Res%>%filter(LOQ.type=="LOQ.T0" & Exclusion.CAS!="Excluded_None"))%>% group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(unique(Site.Year)))

nsample1 <- driverdata1 %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Refined_Metals_PAH","Excluded_Metals","Current_Use")))
```


```{r}
library(dplyr)
library(tidyverse)
chemclass <- chemclass %>% mutate(CAS=as.character(CAS))
table13 <- driverdata1 %>% left_join(Res%>% dplyr::filter(LOQ.type=="LOQ.T0" & Exclusion.CAS!="Excluded_None"))%>% dplyr::group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic) %>% mutate(N=length(unique(Site.Year))) %>% filter(Component!="All Other")%>% ungroup%>% dplyr::group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic,N,CAS) %>% dplyr::summarise(HQmax=max(HQ,na.rm=T),N1=sum(HQ>1,na.rm=T),N2=sum(HQ>0.5,na.rm = T),N3=sum(HQ>0.1),freq=length(HQ),freq1=sum(HQ>0))%>%mutate(freq=freq/N) %>% filter((Group_AF1_Chronic=="I" & N1>0) | (Group_AF1_Chronic=="IIIA" & N2>0) | (Group_AF1_Chronic=="IIIB" & N3>0)) %>% left_join(chemclass) %>% dplyr::select(c('LOQ.type', 'Exclusion.CAS', 'Group_AF1_Chronic', 'N',"Substance","HQmax","N1","N2","N3","freq","Chem.Group","class")) %>%filter(freq>0.05)
```


```{r}
nrow(table13)
names(table13)[7:9] <- c("N1-#HQ>1","N2-#HQ>0.5","N3-#HQ>0.1")
write.csv(table13,file="inst/manuscript_additional/table13_Chronic.csv")
```


```{r}
table13%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.,columns = 1:4)
```


- assemble the driver dataset with data from same sampling sites/stations
- Filter by HI>1 *** Note this was added after the email on 7/13 from Ismael



```{r}
driverdata2 <- rbind(driverdata1 %>% filter(Exclusion.CAS!="Current_Use" & test=="Chronic"),currentdat1)
driverdata2 <- driverdata2 %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Refined_Metals_PAH","Excluded_Metals","Current_Use")))%>%filter(HI>0.1)


nsample2 <- driverdata2 %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Refined_Metals_PAH","Excluded_Metals","Current_Use")))
```

- Genera Figure 3


```{r}
detach("package:plyr")
sumdriver1 <- driverdata1 %>% group_by(LOQ.type,Exclusion.CAS,test,Site.Year) %>% mutate(sumHQ=sum(HQ))%>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test,Component,Site.Year) %>% summarise(Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

p1 <- ggplot(sumdriver1%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS)+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))+theme(legend.position = "bottom")
p1
if(interactive()){
ggsave("inst/manuscript_additional/Figure3-Chronic-boxplot-sqrt.png",width = 12,height=8,dpi=300)
}
ggplot(sumdriver1%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.01))+theme(legend.position = "bottom")
if(interactive()){
ggsave("inst/manuscript_additional/Figure3-Chronic-boxplot.png",width = 12,height=5,dpi=300)
}
```





```{r eval=T}
pbar1 <- ggplot(driverdata1%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample1 %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)+xlab("")+geom_hline(yintercept = 1,lty=2)+theme(legend.position = "bottom")+ylab("HI")
```


```{r eval=T}
nsample1 <- nsample1 %>% filter(test=="Chronic")                                                  
## A function to plot the inset


## This function allows us to specify which facet to annotate
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}




inset_plot <- NULL
## tmp <- expand.grid(LOQ.type = c("LOQ.T0","LOQ.T1"),Exclusion.CAS = c("Excluded_Metals","Current_Use"))
for(i in 1:1)
  for(j in 1:3){
    inset_plot[[2*(i-1)+j]] <- NA
  }

names(inset_plot) <- paste0(nsample1$LOQ.type,"-",nsample1$Exclusion.CAS)

for (LOQ in c("LOQ.T0")) {
 for(Exclusion in c("Refined_Metals_PAH","Excluded_Metals","Current_Use")){
     p <- ggplot(data=sumdriver1 %>% filter(test=="Chronic" & Exclusion.CAS==Exclusion & LOQ.type==LOQ),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=12) +  ## makes everything smaller
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(1),angle = 45,hjust=1,vjust=1), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
     
     inset_plot[[paste0(LOQ,"-",Exclusion)]] <- p
 } 
}



pbar1+annotation_custom2(grob = ggplotGrob(inset_plot[[1]]), data = data.frame(x=nsample1$sy[1], HQ=nsample1$hmax[1]*0.95, 
                                       LOQ.type=nsample1$LOQ.type[1], 
                                       Exclusion.CAS=nsample1$Exclusion.CAS[1]),
                         xmin = nsample1$sy[1]*0.15, xmax = nsample1$sy[1]*0.95, ymin = nsample1$hmax[1]*0.25, ymax =nsample1$hmax[1]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[2]]), data = data.frame(x=nsample1$sy[2], HQ=nsample1$hmax[2]*0.95,                                        LOQ.type=nsample1$LOQ.type[2], 
                                       Exclusion.CAS=nsample1$Exclusion.CAS[2]),
                         xmin = nsample1$sy[2]*0.15, xmax = nsample1$sy[2]*0.95, ymin = nsample1$hmax[2]*0.25, ymax =nsample1$hmax[2]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[3]]), data = data.frame(x=nsample1$sy[3], HQ=nsample1$hmax[3]*0.95,                                        LOQ.type=nsample1$LOQ.type[3], 
                                       Exclusion.CAS=nsample1$Exclusion.CAS[3]),
                         xmin = nsample1$sy[3]*0.15, xmax = nsample1$sy[3]*0.95, ymin = nsample1$hmax[3]*0.25, ymax =nsample1$hmax[3]*0.95)+theme(strip.text.x = element_text(size =12))#+
  # annotation_custom2(grob = ggplotGrob(inset_plot[[4]]), data = data.frame(x=nsample1$sy[4], HQ=nsample1$hmax[4]*0.95,                                       LOQ.type=nsample1$LOQ.type[4], 
  #                                      Exclusion.CAS=nsample1$Exclusion.CAS[4]),
  #                        xmin = nsample1$sy[4]*0.15, xmax = nsample1$sy[4]*0.95, ymin = 0.25, ymax =nsample1$hmax[4]*0.95)
  # 

# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_additional/Figure3-Chronic-annotated.png",width = 10,height=4.5,dpi=300)
}
```


#### Figure 3 Chronic with same site and year as in the Excluded_Metals_PAH, but with HI greather than 0.1



```{r}
sumdriver2 <- driverdata2 %>% group_by(LOQ.type,Exclusion.CAS,test,Site.Year) %>% mutate(sumHQ=sum(HQ))%>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test,Component,Site.Year) %>% summarise(Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

library(scales)
ggplot(sumdriver2%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))
if(interactive()){
ggsave("inst/manuscript_additional/Figure3-Chronic-boxplot-Chronic-Site.Year-sqrt.png",width = 12,height=5,dpi=300)
}

ggplot(sumdriver2%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.01))
if(interactive()){
ggsave("inst/manuscript_additional/Figure3-Chronic-boxplot-Chronic-Site.Year.png",width = 12,height=5,dpi=300)
}
```





```{r eval=T}

fig3 <- generate_fig3(driverdata2,nsample2,sumdriver2 = sumdriver2)
fig3
# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_additional/Figure3-Chronic-annotated-site-year.png",width = 12,height=5,dpi=300)
}
```



### Figure 4a (barplot)

Figure 4. Main risk drivers 

There are two potential options for this plot 

- Option 1 (geom_bar):  

- Building on the same approach used in Figure 3. We investigate only the chemicals that appear more frequently among the first, second or third risk drivers for the Station_Year observations with HI > 0.1. 

- Pros: We build on previous analysis, and focus only in the chemicals that are most relevant for stations with the larger His. 
- Cons: Does not provide a more general assessment across all chemicals of those that could be of potential relevance (independently on whether they appear or not very frequently in the most risky mixtures). The frequency of appearance depends on (1) concentration (2) frequency of monitoring. This is uncaptured by this analysis. 

Plot: 

- Chronic, identical plot for acute for SM. 
- Frequency (%) as first, second or third component ~ CAS 
- Faceting: (1 x 2) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals") 
- Color by Percentile (as is now) 

- [x] only chronic
- [x] color axis tick label by chemical groups


```{r}
driverdata <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0"), Exclusion.CAS = c("Excluded_None","Refined_Metals_PAH", "Excluded_Metals","Current_Use"), Data.SSD.1,threshold = 1)
sumCAS <- driverdata %>% filter(HI>1) %>% group_by(LOQ.type,Exclusion.CAS,test)%>%mutate(nSample=length(unique(Site.Year))) %>% group_by(LOQ.type,Exclusion.CAS,test,CAS,nSample) %>%nest() %>% mutate(nappear=purrr::map(data,nrow))%>% unnest(cols=c(nappear))%>% mutate(freq=nappear/nSample ) %>% select(-data) %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest() %>% mutate(data=purrr::map(data,function(df){
  df <- df[order(df$freq,decreasing = T),]
  df <- df%>%add_column(x=1:nrow(df))
  return(df)
}))%>%unnest(cols = c(data))%>%ungroup #%>% mutate(x=paste0(x,"-",CAS))

sumCAS <- sumCAS %>% left_join(chemclass[,c("CAS","Substance","Chem.Group","class")]%>%mutate(CAS=as.character(CAS)))%>%filter(CAS!="")%>% filter(x<=41) 
```

```{r}
write.csv(sumCAS,file="inst/manuscript_additional/table_fig4a.csv")
```


- generate figure 4a

```{r}
for(excludecas in c("Excluded_None","Refined_Metals_PAH", "Excluded_Metals","Current_Use")){
  fig4a <- generate_fig4a(sumCAS = sumCAS, Exclusion.CAS = excludecas,chemclass=chemclass)
  fig4a+theme(strip.text.x = element_text(size=12),axis.text=element_text(size=12,hjust=1),legend.direction = "vertical")
  if(interactive()){
    ggsave(paste0("inst/manuscript_additional/Figure4a-Chronic-",excludecas,".png"),width = 10,height=8,dpi=300)
  }
}




```



### Figure 4b (dotplot)

Option 2 (geom_point): 

We approach the relevance as HQ quantiles per CAS. Quantiles P95, P75, P50, P25, ordered by P95. We explore the frequency in which each CAS is found at RQ levels of reference (RQ = 0.01, 0.1, 1). Only the chemicals found beyond certain level, at certain frequency can have probability of being relevant overall for the mixtures. 

- Pros: Explore in a more detail way the potential contribution of all CAS to overall risk. Further, information on the frequency of monitoring and detection, and LOQs can be easily added to the plot for enhance transparency and interpretation. 
- Cons: Not directly linked to previous analysis (Figure 3). A little less direct to link single chemical relevance to "mixture effects". 

Plot: 

- Chronic, identical plot for acute for SM. 
- HQ ~ CAS (for Quantiles P95, P75, P50, P25, ordered by P95) 
- @Zhenglei. To add min(LOQ) per CAS to the plot with a different symbol 
- Faceting: (1 x 2) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals") 
- Color by "Chem.Group (Metal, Industrial, PAH, Pharma, Pesticide) 

- [x] color axis tick label by chemical groups
- [x] add number of sites and samples with this CAS. 

```{r}
data(casdata)
```



```{r}
for(excludecas in c("Excluded_None","Refined_Metals_PAH", "Excluded_Metals","Current_Use")){
  fig4b <- generate_fig4b(Data.AggBySiteID.2,chemclass=chemclass,Data.SSD.1=Data.SSD.1,LOQ.type= c("LOQ.T0"),driverdata,Exclusion.CAS=excludecas)
  fig4b+theme(strip.text.x = element_text(size=12))
  if(interactive()){
    ggsave(paste0("inst/manuscript_additional/Figure4b-Chronic-",excludecas,".png"),width = 10,height=9,dpi=300)
  }
}


```


- table 4b: Do not limit the Table based on HQ (the idea is to be able to see all CAS numbers ordered in this table including those with a low HQ).

```{r}
Exclusion.CAS <- "Excluded_Metals"
 HQdata <- getHQData_Chronic(Data.AggBySiteID.2,chemclass=chemclass,Data.SSD.1=Data.SSD.1,LOQ.type= c("LOQ.T0"),driverdata,Exclusion.CAS=Exclusion.CAS)
  sumCAS <- HQdata %>% mutate(test="Chronic") %>%group_by(LOQ.type,test)%>%mutate(nSample=length(unique(Site.Year))) %>% group_by(LOQ.type,test,CAS,nSample) %>%nest() %>% mutate(nappear=purrr::map(data,nrow),QI=purrr::map(data,function(df) quantile(df$HQ.Chronic,c(0.25,0.5,0.75,0.95,1))))%>% unnest(cols=c(nappear,QI))%>% mutate(freq=nappear/nSample ) %>% select(-data) %>% mutate(Quantile=c("25%","50%","75%","95%","100%"))%>% group_by(LOQ.type,test,CAS)%>% mutate(q95=QI[Quantile=="95%"])%>% #filter(q95>0.01)%>%
    group_by(LOQ.type,test)%>%nest()%>%mutate(data=purrr::map(data,function(df){
    df <- df %>% group_by(CAS,q95) %>% nest()
    df <- df[order(df$q95,decreasing=TRUE),]
    df <- df %>% add_column(x=1:nrow(df))
    df <- df %>% unnest(cols=c(data))
    return(df)
  }))%>%unnest(cols = c(data))%>%ungroup #%>% mutate(x=paste0(x,"-",CAS))

  sumCAS <- sumCAS %>% left_join(casdata[,c("CAS","Substance","Chem.Group","class","Nmeasured","Ndetected","LOQ","LOQ.Chronic","LOQ.Acute")]%>%mutate(CAS=as.character(CAS)))%>%filter(CAS!="") ##%>% filter(x<=41)
  sumCAS1 <- sumCAS %>% pivot_wider(names_from = "Quantile",values_from="QI",names_prefix="Q")
  write.csv(sumCAS1,file=paste0("inst/manuscript_additional/table_fig4b_",Exclusion.CAS,"_all.csv"))

```







```
> summary(Data.AggBySiteID.2$procedureLOQValue)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.00e+00 0.00e+00 0.00e+00 7.33e+01 1.00e-01 1.00e+06 
> sum(Data.AggBySiteID.2$procedureLOQValue < Data.AggBySiteID.2$resultMeanValue)
[1] 99126
> sum(Data.AggBySiteID.2$procedureLOQValue < Data.AggBySiteID.2$resultMeanValue)/nrow(Data.AggBySiteID.2)
[1] 0.1599839
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMeanValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0.6066274
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])
[1] 0
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0
> sum(Data.AggBySiteID.2$AboveLOQ)
[1] 158252
> sum(Data.AggBySiteID.2$resultMeanValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0

```

