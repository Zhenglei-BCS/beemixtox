---
title: "Manuscript Preparation"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{msPAF}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  eval=T,
  fig.width = 12,
  fig.height = 10
)
```



## Background

PAF(potentially affected fraction) definition: inverse way of $HC_p$. Given a concentration, find out $p$. In general, PAF can be considered an indicator for "toxic pressure" on the ecosystems.

The quantile (or PAF) for each species was calculated approximately by $\frac{i-0.5}{n}$, where $i$ is the rank of the sensitivity, $i=1$, the most sensitive and $n$ the least sensitive species.

$\alpha$ intercept, $\beta$ slope.


if assuming log-logistic distribution.

$$PAF(x)=1/(1+\exp((\alpha-x)/\beta))$$
$\alpha$ is the mean value of the log-logistic distribution, $\beta$ is the scale parameter. $x$ is log of the concentration. $\beta=\sigma\times\sqrt{3}/\pi$

Rewriting above into $x=\alpha-\beta\log(\frac{1-PAF}{PAF})$, when $x=HC_5$ then $PAF=0.05$


The current method to calculate the $HC_5$ and $HC_{50}$ makes use of the log-normal
species sensitivity distribution (Aldenberg and Jaworska, 2000) instead of a log-logistic
distribution. The differences between these two distributions are small. *The advantage of analytic tractability of the logistic distribution is outweighed by the
statistical advantage of using the log-normal distribution. (Personally I don't understand this sentence)*

Assuming log-normal

$$\log(HC_p)=x-k\cdot s$$

where $x$ is the mean of the log-transformed data, $k$ is the extrapolation constant depending on protection level and sample size (Aldenberg and Jaworska, 2000), $s$ is the standard deviation of log-transformed data. 

### msPAF (multisubstance PAF)

An aggregation protocol has been designed to aggregate single-substance PAF
values to a single overall term of ecological risk of a mixture. The protocol is based
on application of two toxicological concepts: concentration addition (termed Simple
Similar Action by Plackett and Hewlett, 1952) and response addition (termed Independent
Joint Action by Plackett and Hewlett, 1952). The concepts are summarized
and the associated rules of calculus are introduced below.


### Concentration Addition 

The toxicological concept of concentration addition has been defined for compounds
that have the same toxic mode of action and that show no toxicological interactions
(Plackett and Hewlett, 1952). This concept is usually applied to characterize the
response observed in single-species toxicity tests in which the response to several
compounds with the same mode of action is considered. By definition, the joint
effect of such compound mixtures can be calculated using (relative) concentration
addition rules of calculus (Plackett and Hewlett, 1952; Deneer et al., 1988a; Altenburger
et al., 2000; Chapter 15).

Neutral hydrophobic organic compounds are believed to act by a similar, nonspecific
toxic mode of action called *narcosis*, which every hydrophobic compound
can exert, but which can be masked by another, more specific toxic effect (Könemann,
1981). In other words, almost every hydrophobic chemical exerts at least a
narcotic, nonspecific toxicity that contributes to the joint toxicity of mixtures, and
this is often referred to as baseline toxicity (Verhaar et al., 1992; 1995). At the species level, toxicity equivalence factors (TEFs) have been used to express the toxicity of one compound as a fraction of another compound with the same toxic mode of
action. Transfer of the TEF principle to SSDs by scaling compounds in a similar
way results in so-called hazard units (Box 16.1). For compounds with the same toxic
mode of action, a single SSD can be derived using (relative) concentration addition
quantified by hazard units, representing the separate compounds and any mixture of
these compounds. It is assumed that the toxic mode of action in this case applies to
the SSD comprising all relevant species.

For compounds with a non-narcotic toxic mode of action, the situation is more
complicated. Some species experience the same type of effect due to specific interactions at targets sites that only occur in a fraction of the species, and other species only experience narcosis, due to lack of specific target sites for the compound. This holds, for example, for organophosphate (OP) biocides. Each OP biocide acts by
acetylcholinesterase inhibition, and thus all compounds in this group can be seen as
fractions of each other provided that the exposed organisms have a receptor for this
compound. For those organisms, concentration addition rules of calculus should be
applied for the specifically working OP biocides. However, species that lack the
target receptor are not sensitive for OP exposure, and will only experience narcotic
baseline toxicity. This means that concentration addition for specific toxic modes of
action is only appropriate within a single SSD if the SSD consists of species having
the specific receptor. For the organisms without the receptor, it may be more useful
to consider narcotic concentration addition. Moreover, compounds can be more toxic
than expected from baseline toxicity, although the exposed species do not have the
receptor for a compound. These complications are further elaborated in Chapter 22.

As a method to aggregate several PAF values from SSDs for compounds with
a similar toxic mode of action to a single msPAF term, it is proposed to apply
concentration addition rules. The cumulative density function (CDF) of (log) toxicity
data is regarded as similar to the log-dose–response curve for single species. This
is illustrated in Box 16.1 for NOECs, but the principle can be applied to other test
endpoints as well.

**Toxicity Data**

1. Obtain NOECs for each compound.
2. mg/L for aquatic organisms, mg/L soil pore water for soil organisms.
3. scale into dimensionless HU (hazard units), with 1 HU defined as the concentration where the NOEC is exceeded for 50% of all species tessted. 
 $$\bar NOEC_i^j=\frac{NOEC_i^j}{\bar x_i}$$
 where, $\bar NOEC_i^j$ is the scaled NOECs in HUs ($\mu$g/L/$\mu$g/L). $\bar x_i$ the median NOEC for substance $i$. $i=1, ..., n$, and species $j$ from $1,...,m$.

4. This is analogous to toxic unit (TU) scaling for a single species where 1 TU is the concentration causing 50% effect. 
5. Fitting SSD with either log-logistic model or log-normal in HUs for each compound. Alternatively, it can be found by shifting the CDF of log NOECs by subtracting log($\bar x_i$). 
6. Concentration addition in the context of SSDs implies that **SSDs have
similar variance** for compounds with the same toxic mode of action. The hypothesis is $H_0: \sigma_A=\sigma_B$. If they differ significantly, no rules of calculus
have as yet been developed to take divergence in variance (equivalent to
slope divergence in the classical concentration addition literature; see
Bliss, 1939; Plackett and Hewlett, 1952; De March, 1987) into account.
If they do not differ, this does not prove concentration additivity; it can
also be a result of small sample sizes.

**Exposure Data**

7. For each compound the exposure conentration is recalculated to HU.

**PAF Calculations for Concentration Addition (CA)**
8. The $msPAF_{CA}$ is read from the CDF by HU addition (non-log-transformed)
for a single toxic mode of action (TMoA):

$$HU_{TMoA}=\sum_i HU$$
9. If the log toxicity data are fitted to a logistic distribution, the PAF for each compound is given by 

$$PAF_i=\frac{1}{1+e^{-(x-\alpha)/\beta}}$$

with $\alpha$ mean of the log toxicity data and $\beta=\sigma\cdot\sqrt 3/\pi$, $\sigma$ the sd and $x$ the log of the exposure concentration.

10. After recalculation of all compound concentrations to HUs, $\alpha=0$ by definition and $x$ is given by the sum of $HU_{TMoA}$ of all compounds with the same toxic mode of action. The $\beta$ is averaged over the compounds or, alternatively, can be derived from a database analysis for the toxic mode of action.

11. the $msPAF_{CA}$ for a group of substances
with the same toxic mode of action is calculated as

$$PAF_{TMoA}=\frac{1}{1+e^{-\log(\sum HU_{TMoA}))/\beta_{TMoA}}}$$

### Response Addition (Not used in the calculation)

For compounds that have different modes of action, and that do not interact at the
target site of toxic action, mixture toxicity can be described by the term
response addition (RA), initially referred to as Independent (Joint) Action (Bliss, 1939; Plackett and Hewlett, 1952). This concept is usually applied to characterize the response observed in single-species toxicity tests for chemicals with dissimilar modes of action. A correlation of sensitivities to the different compounds is absent.

**PAF Calculations for Response Addition**

- The combination effect for compounds with different modes of action is
calculated analogous to the probability of two nonexcluding processes
(Hewlett and Plackett, 1979), where a species is affected by compound A
and/or B:

$$P(A \cup B) = P(A)+P(B)-P(A\cap B)$$
- For $P(A\cap B)$ These are related to the covariation of sensitivities, denoted by
r.

- When $r=0$, then $P(A\cap B)=P(A)\cdot P(B)$, which leads to 

$$PAF_{RA}=P(A)+P(B)-P(A)\cdot P(B)
$$
- To simplify for  multiple compound mixtures. The nonaffected fraction, is
introduced. If $Q_A=1-PAF_A$, and $Q_B=1-PAF_B$, the nonaffected fraction
of the mixture of A and B is a part of $Q_A$ of $Q_B$. 

$$Q_{AB}=Q_A\cdot Q_B
$$

- Then msPAF is given by:
$$
PAF_{RA}=1-Q_{AB}=1-(1-PAF_A)(1-PAF_B)
$$
- For more compounds

$$
PAF_{RA}=1-\Pi_i(1-PAF_i)
$$
### Aggregation to msPAF

The substances comprising the mixture are grouped in three different
types: (a) one or more groups of compounds in which there is within-group concentration
addition, (b) groups of compounds distinguished by between-group
response addition, and (c) remaining compounds with a toxic mode of action that
is unique for the given mixture. Calculation of overall msPAF of all the compounds
from the three different types a to c then proceeds in the following order:


1. SSDs are calculated for each compound, yielding as many (single-substance)
SSDs as there are compounds on the list.
2. Concentration addition (according to Box 16.1) is applied to each group
of compounds with the same toxic mode of action, to aggregate single
PAFs for compounds of type a, showing within-group concentration addition.
This yields msPAF values based on concentration addition ($msPAF_{CA}$)
for as many modes of action as are distinguished in the mixture.
3. Response addition according to Box 16.2 is applied to the $msPAF_{CA}$ values
obtained in step 2 with the remaining single PAF values (aggregating over
types a to c).


## Toxic Pressure Modelling

$$\mbox{Toxic Pressure} = \Pr(C_w>EC_{50}) = \int_{-\infty}^{\infty}pdf(zC_w)\times CDF(zEC_{50})dz$$
with $z(C_w)=\frac{\log C_w-av(\log EC_{50})}{sd(\log EC_{50})}$ and 

$z(EC_{50})=\frac{\log EC_{50}-av(\log EC_{50})}{sd(\log EC_{50})}$, where $pdf(zC_w)$ and $CDF(zEC_{50})$ represent the pdf of toxicologically standardized exposure concentrations (in water) and the cdf of toxicologically standardized acute $EC_{50}$ values. 

Values of $sd(\log EC_{50}$ are often not
known with great precision for many chemicals, because of
insufficient numbers of experimental toxicity data (Posthuma
et al. 2019b). Following the practice of Posthuma et al. (2019b),
we assigned the value 0.7 to across‐species standard
deviations of all individual chemicals, for the purpose of toxic
pressure calculation.

## Question from Ismael

b.	I calculated the msPAF according to the equation, and checked if the sum of the individual PAF values (calculated for each chemical individually) is equal to the calculated msPAF for the mixture. In fact the sum(PAF) underestimate the msPAF and is dependent on n components. I think it is logical because the equation involves operations in log scales and CDFs, so that msPAF(1+2) is not equal to PAF1 + PAF2. 
c.	The question is: How can I calculate the fractional contribution of each chemical X to the msPAF? Do you think it is possible? Or may there be a magical mathematical approximation to solve this problem?

**My thoughts**

similar to the frequent practice of water quality assessment for mixtures by *linearly summed risk quotients over compounds*, whereby numerical values estimated
with the simplified and the original (more complex) model are similar.


Relative rankings of the contributions of chemicals to those impacts on a regional scale
were derived in 2 steps. In the first step, *a relative toxicity score for each compound* in a subset of samples (Europe or a specific example river basin) was determined as the product of the *mean compound toxic pressure* in the set and *the ratio between the non-zero values for that compound and the non-zero values for the mixtures*. Those represent the magnitude and the relative contribution and frequency of increased compound pressures to total mixture pressures. All scores were then relatively ranked using the lowest-ranking compound as the baseline (defined as “1”).

A PAF value relates to the concept of protective
benchmarks, if those are derived from an SSD of chronic
NOECs, such as the hazardous concentration for 5% of the
species (HC5). Higher toxic pressures imply higher fractions of
species affected for the studied acute or chronic endpoint.

sufficient protection relates to PAF-NOECmax=
msPAF-NOECmax=0.05, which is in regulatory terms considered
to protect 95% of the species against adverse effects.


The observed Pareto-type
(skewed) distributions imply that relatively few sites are
characterized by relatively high chronic toxic pressures.

toxic pressure data aggregated over an area and over time.


## Reproducible R Script and Output

- take only Lake water body and River water body data.
- SSD data from L.Posthuma SSDs
- Keep only "total water" to avoid replications
- remove rows with Missing observed value ("O" category) and unreliable meta info ("U" category).
- Remove 85 rows with measurement has been confirmed by country to be taken from a highly polluted area 



- LOQ.type = "LOQ.T0", The values that are below LOQ are set to 0 $\mu$g/L.
- Exclude priority pollutants entries and metals.
- Note here we can make it a parameterized report or using functions if necessary. 




- use monitoring site, Year as grouping variables to calculated the number of measured, the number of detected, and the ratio as detection rate. 
- left join the aggregated dataset with SSD information with CAS being the identifier.

- [ ] check code against Ismael's. 

## Table for the Manuscript

- CEFIC-MIAT decision tree table (Valloton &Proce 2016) 
- Group I: Risk driven by single chemicals HI >1 & MaxHQ >1
- Group II:No concern HI < 1, MaxHQ < 1
- Group IIIA: Mixtures concern driven by 1 or 2 chemicals. HI>1 & Max HI <1 & MCR < 2
- Group IIIB: Mixture risk. HI > 1 & MaxHQ < 1 & MCR >2

Table 1. CEFIC-MIAT Table 

- Include only AF 1 (Do we want to include other Afs?) 
- Chronic, same for Acute (for SM Materials) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_None", "Excluded_Metals_PAH", "Current_Use") 
- Generate identical Table for Acute for SM. 



## Figures for the Manuscript


```{r}
library(beemixtox)
library(quantreg)
data("Data.AggBySiteID.2")
data("Data.SSD")
data("chemclass")
CAS.SSD = unique(Data.AggBySiteID.2$CAS)[unique(Data.AggBySiteID.2$CAS)%in%as.character(unique(Data.SSD$CAS.))]
Data.SSD.1 = Data.SSD[Data.SSD$CAS.%in%CAS.SSD,]; Data.SSD.1 = droplevels(Data.SSD.1)

```

### Figure 1

Figure 1. log10(HI)-MCR Plots. Faceted plot (2x3). 

Chronic, same for Acute (for SM Materials) 

LOQ.type = c("LOQ.T0", "LOQ.T1") 

Exclusion.CAS = c("Excluded_None", "Excluded_Metals_PAH", "Current_Use") 

To do: 

- [x] Check the function defining the regions (Group II, Group I, Group IIIa, Group IIIb) 

- [x] Add annotation with the name of the group and % of samples 

- [x] Add annotation with the N.Site_Year, N.CAS 

- [ ] Question about N-CAS! Measured in this particular dataset or detected? Or in terms of all sites.  

- [x] Add colored sharing to the no concern group 
- [ ] Table 13: Substances driving the cumulative risks for each of the mixture groups in the Rhine dataset under the more realistic scenario

**Note that 1808 site.year has HI of 0, around 15.5 %**




```{r}
Res <- getResData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0","LOQ.T1"),
            Exclusion.CAS = c("Excluded_None","Excluded_Metals_PAH","Current_Use"),Data.SSD.1)
```

```{r}
recting <- rbind(data.frame(xmin=-Inf,xmax=1,ymin=-Inf,ymax=Inf,col="green"),
                 data.frame(xmin=1,xmax=Inf,ymin=0,ymax=2,col="red"),
                  data.frame(xmin=1,xmax=Inf,ymin=2,ymax=Inf,col="yellow"))
```

```{r}
sum(Res$HI_Acute==0 & Res$Exclusion.CAS=="Excluded_None" & Res$LOQ.type=="LOQ.T0")
sum(Res$HI_Acute==0 & Res$Exclusion.CAS=="Excluded_None" & Res$LOQ.type=="LOQ.T1")

df <- data.frame(x=1e-6,y=9)

N_CAS_Site <- Res %>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(N.Site=length(unique(monitoringSiteIdentifier)),N.Sample=length(monitoringSiteIdentifier)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_None","Excluded_Metals_PAH","Current_Use")))
N.CAS <- sapply(c("Excluded_None","Excluded_Metals_PAH","Current_Use"),function(x)getNcas(x,chemclass))
N_CAS_Site$N.CAS <- rep(N.CAS[unique(N_CAS_Site$Exclusion.CAS)],2)
N_CAS_Site <- data.frame(df,N_CAS_Site)

Nclass <- Res %>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Acute) %>% summarise(N=length(monitoringSiteIdentifier))%>% left_join(N_CAS_Site[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)

Nclass1 <- Nclass %>% filter(Group_AF1_Acute=="IIIA" | Group_AF1_Acute =="IIIB")%>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(Perc=sum(Perc)) %>% mutate(Group="III")

Nclass <- rbind(Nclass1,Nclass[,c("LOQ.type","Exclusion.CAS","Perc","Group_AF1_Acute")]%>%rename(Group=Group_AF1_Acute)%>%filter(Group=="I"|Group=="II"))

df1 <- data.frame(x=1e-6,y=7,Label="No concern",Group="II")
df1 <- rbind(df1,data.frame(x=20,y=5,Label="Single Substance Risk",Group="I"))
df1 <- rbind(df1,data.frame(x=5,y=10,Label="Multiple Chemicals Risk",Group="III"))
Nclass <- Nclass %>% left_join(df1)
#ggplot(Res,aes(x=log10(HI_Acute),y=MCR.HC50.Acute.EC50))+geom_point()+geom_text(data=df,aes(x=x,y=y),label=paste0("N.Site = ",10,"\nN.CAS = ",5))+facet_grid(LOQ.type~Exclusion.CAS)
ggplot(Res,aes(x=HI_Acute,y=MCR.HC50.Acute.EC50))+geom_point(aes(col=Group_AF1_Acute))+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass,aes(x=x,y=y,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust="inward") +scale_x_log10()+geom_vline(xintercept = 1,col="blue")+geom_hline(yintercept = 2,col="blue")+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y),col="blue")+theme(legend.position = "bottom")
# geom_rect(data=recting,aes(xmin=xmin, xmax=xmax, ymin=ymin, ymax=ymax,fill=col))
# ggplot(data.frame(x=1:10,y=1:10),aes(x=x,y=y))+geom_point()+scale_x_log10()+ geom_line() 
if(interactive()){
  ggsave("inst/manuscript_v2/Figure1-Acute.png",width = 15,height=8,dpi=300)
}

N_CAS_Site$y <- 8


Nclass <- Res %>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(monitoringSiteIdentifier))%>% left_join(N_CAS_Site[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
Nclass1 <- Nclass %>% filter(Group_AF1_Chronic=="IIIA" | Group_AF1_Chronic =="IIIB")%>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(Perc=sum(Perc)) %>% mutate(Group="III")

Nclass <- rbind(Nclass1,Nclass[,c("LOQ.type","Exclusion.CAS","Perc","Group_AF1_Chronic")]%>%rename(Group=Group_AF1_Chronic)%>%filter(Group=="I"|Group=="II"))

df1 <- data.frame(x=1e-6,y=4,Label="No concern",Group="II")
df1 <- rbind(df1,data.frame(x=50,y=5,Label="Single Substance Risk",Group="I"))
df1 <- rbind(df1,data.frame(x=5,y=9,Label="Multiple Chemicals Risk",Group="III"))
Nclass <- Nclass %>% left_join(df1)


ggplot(Res,aes(x=HI_Chronic,y=MCR.HC05.Chronic.NOEC))+geom_point(aes(col=Group_AF1_Chronic))+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))+geom_text(data=Nclass,aes(x=x,y=y,label=paste0(Group,"\n",formatC(Perc,digits = 2,format="f"),"%")),vjust="inward")  +scale_x_log10()+geom_vline(xintercept = 1)+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+ annotate("rect", xmin = 1e-10, xmax = 1, ymin = recting[1,3], ymax = recting[1,4],fill="yellow",alpha=0.2)+geom_line(data=data.frame(x=seq(1,10,length=100),y=seq(1,10,length=100)),aes(x=x,y=y))+scale_y_continuous(limits=(c(1,10)),expand = c(0,0))+theme(legend.position = "bottom")
if(interactive()){
  ggsave("inst/manuscript_v2/Figure1-Chronic.png",width = 15,height=8,dpi=300)
}
```


Table 1. CEFIC-MIAT Table 

- Include only AF 1 (Do we want to include other Afs?) 
- Chronic, same for Acute (for SM Materials) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_None", "Excluded_Metals_PAH", "Current_Use") 
- Generate identical Table for Acute for SM. 

```{r}
N_CAS_Site_tmp <- Res %>% group_by(LOQ.type,Exclusion.CAS) %>% summarise(N.Site=length(unique(monitoringSiteIdentifier)),N.Sample=length(monitoringSiteIdentifier)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_None","Excluded_Metals_PAH","Current_Use")))
table_chronic <- Res%>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(monitoringSiteIdentifier))%>% ungroup %>% left_join(N_CAS_Site_tmp[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
if(interactive()){
  write.csv(table_chronic,file="inst/manuscript_v2/table_chronic.csv")
}

```


```{r}
table_chronic%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.)
```


```{r}
table_acute <- Res%>% group_by(LOQ.type,Exclusion.CAS,Group_AF1_Acute) %>% summarise(N=length(monitoringSiteIdentifier))%>% ungroup %>% left_join(N_CAS_Site_tmp[,c("LOQ.type","Exclusion.CAS","N.Sample")])%>% mutate(Perc=N/N.Sample*100)
if(interactive()){
  write.csv(table_acute,file="inst/manuscript_v2/table_acute.csv")
}
```

```{r}
table_acute%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.)
```


### Figure 2

Figure 2.  log10(HI)-N.Chemicals Measured & Detected. Faceted plot (2x4?). 

Chronic, same for Acute (for SM Materials) 

LOQ.type = c("LOQ.T0", "LOQ.T1") 

Exclusion.CAS = c("Excluded_None" (for N.Measured), "Excluded_None", "Excluded_Metals_PAH", "Current_Use") 

To do: 

- [x] Add annotation with the name of the group and % of samples (only Group II, no concern) 
- [x] Add annotation with the N.Site_Year, N.CAS 
- [x] Add colored sharing to the no concern group 
- [ ] superpose boxplots


```{r}
df <- data.frame(x=200,y=1e-6)

tmp <- Res[,c("HI_Acute","HI_Chronic","Ndetected","Nmeasured","LOQ.type","Exclusion.CAS")]

tmp <- tmp %>% pivot_longer(cols = c(Ndetected,Nmeasured),values_to="N",names_to="Ntype") %>% filter(Ntype=="Ndetected"|(Ntype=="Nmeasured" & Exclusion.CAS=="Excluded_None"))
tmp$Exclusion.CAS <- factor(tmp$Exclusion.CAS,levels=(c("Excluded_None","Excluded_Metals_PAH","Current_Use")))
tmp$Ntype<- factor(tmp$Ntype,levels=(c("Nmeasured","Ndetected")))

sumtmp <- tmp %>% group_by(LOQ.type,Exclusion.CAS,Ntype)%>%summarise(Perc=sum(HI_Acute<1)/length(HI_Acute)*100,x1=max(N)) 
sumtmp <- cbind(df,sumtmp)
N_CAS_Site$x <- sumtmp$x[1]
N_CAS_Site$y <- 1e-03
N_CAS_Site$Ntype <- "Ndetected"
N_CAS_Site <- rbind(N_CAS_Site,N_CAS_Site%>%filter(Exclusion.CAS=="Excluded_None") %>% mutate(Ntype="Nmeasured"))
N_CAS_Site$Ntype<- factor(N_CAS_Site$Ntype,levels=(c("Nmeasured","Ndetected")))
N_CAS_Site$Exclusion.CAS <- factor(N_CAS_Site$Exclusion.CAS,levels=(c("Excluded_None","Excluded_Metals_PAH","Current_Use")))

ggplot(tmp,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(LOQ.type~Exclusion.CAS+Ntype)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)
if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Acute.png",width = 12,height=8,dpi=300)
}


ggplot(tmp,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(LOQ.type~Exclusion.CAS+Ntype)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")))+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)),hjust=1)+scale_x_log10()
if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Acute-logxy.png",width = 12,height=8,dpi=300)
}


N_CAS_Site_1<- left_join(N_CAS_Site,sumtmp[,-c(1,2)])

# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"]*0.7
# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0" & N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0"& N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"]*0.7
N_CAS_Site_1$y <- 0.00005


#sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"]*0.7
#sumtmp[sumtmp$LOQ.type=="LOQ.T0" & sumtmp$Exclusion.CAS=="Excluded_None","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T0"& sumtmp$Exclusion.CAS=="Excluded_None","x1"]*0.7


ggplot(tmp,aes(x=N,y=HI_Acute))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_wrap(LOQ.type~Exclusion.CAS+Ntype,scales="free_x",ncol=4)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red",formula=y ~ qss(x, lambda = 3))+scale_y_log10()+geom_text(data=sumtmp,aes(x=x1,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x1,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)),hjust=1)#+coord_cartesian(clip = 'off')




if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Acute-free_x.png",width = 12,height=8,dpi=300)
}

```

**Figure 2 Chronic**

```{r}
sumtmp <- tmp %>% group_by(LOQ.type,Exclusion.CAS,Ntype)%>%summarise(Perc=sum(HI_Chronic<1)/length(HI_Chronic)*100,x1=max(N)) 
sumtmp <- cbind(df,sumtmp)


ggplot(tmp,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(LOQ.type~Exclusion.CAS+Ntype)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")))+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)))
if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Chronic.png",width = 12,height=8,dpi=300)
}


ggplot(tmp,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_grid(LOQ.type~Exclusion.CAS+Ntype)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()+geom_text(data=sumtmp,aes(x=x,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")))+geom_text(data=N_CAS_Site,aes(x=x,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS)))+scale_x_log10()
if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Chronic-logxy.png",width = 12,height=8,dpi=300)
}
N_CAS_Site_1<- left_join(N_CAS_Site,sumtmp[,-c(1,2)])

# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T1","x1"]*0.7
# N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0" & N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"] <- N_CAS_Site_1[N_CAS_Site_1$LOQ.type=="LOQ.T0"& N_CAS_Site_1$Exclusion.CAS=="Excluded_None","x1"]*0.7
N_CAS_Site_1$y <- 0.00005


# sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T1","x1"]*0.7
# sumtmp[sumtmp$LOQ.type=="LOQ.T0" & sumtmp$Exclusion.CAS=="Excluded_None","x1"] <- sumtmp[sumtmp$LOQ.type=="LOQ.T0"& sumtmp$Exclusion.CAS=="Excluded_None","x1"]*0.7



p <- ggplot(tmp,aes(x=N,y=HI_Chronic))+geom_point(pch=".")+geom_hline(yintercept = 1,col="blue")+facet_wrap(LOQ.type~Exclusion.CAS+Ntype,scales = "free_x",ncol=4)+ annotate("rect", xmin = 0, xmax = Inf, ymin = 0, ymax = 1,fill="yellow",alpha=0.2)+geom_quantile(method = "rqss", quantiles = c(0.1, 0.5, 0.95), colour = "red")+scale_y_log10()
p+geom_text(data=sumtmp,aes(x=x1,y=y,label=paste0("II: ",formatC(Perc,digits = 1,format="f"),"%")),hjust=1)+geom_text(data=N_CAS_Site_1,aes(x=x1,y=y,label=paste0("N.Site = ",N.Site,"\nN.CAS = ",N.CAS,"\nN.Sample = ",N.Sample)),hjust=1)
if(interactive()){
  ggsave("inst/manuscript_v2/Figure2-Chronic_free_x.png",width = 12,height=8,dpi=300)
}

```


### Figure 3

Figure 3.  
- HI vs Station (Stacked bar plot) HI by 1th, 2th, 3th, and all Other components (for Station_Year with HI > 0.1) 
- Boxplot (inside the Stacked bar plot) with the % Risk by 1th, 2th, 3th, all other component. 
- Faceted plot (2x2) 
- Chronic, same for Acute (for SM Materials) 

- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals_PAH", "Current_Use") 

- [ ] superpose boxplot


*check the main drivers! breakdown the HI into driver 1, 2, 3 and other.*


**Get Driver Data for Plotting the Figures**

```{r}
driverdata <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0", "LOQ.T1"), Exclusion.CAS = c("Excluded_Metals_PAH", "Current_Use"), Data.SSD.1,threshold = 1)
```


```{r}
ggplot(driverdata,aes(x=Site.Year,y=HQ))+geom_bar(aes(fill=Component,col=Component),position="stack",stat = "identity")+facet_grid(LOQ.type~Exclusion.CAS+test)



sumdriver <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test,Component) %>% summarise(HQ=sum(HQ)) %>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test) %>% mutate(sumHQ=sum(HQ),Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

ggplot(sumdriver,aes(x=Component,y=Perc))+geom_bar(aes(fill=Component),stat="identity")+facet_grid(LOQ.type~Exclusion.CAS+test)+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.1))



driverdata1 <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test) %>% nest()%>% mutate(data=purrr::map(data,function(df){
  df1<- df%>%group_by(Site.Year,monitoringSiteIdentifier,phenomenonTimeReferenceYear,HI) %>% nest()
  
  df <- df1[order(df1$HI,decreasing = T),]%>% add_column(x=1:nrow(df1))%>%unnest(cols = c(data))%>% ungroup
  return(df)}))%>%unnest(cols = c(data))%>%mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))
driverdata1 <- driverdata1 %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))

nsample <- driverdata %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))


ggplot(driverdata1%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)




 # annotation_custom(grob = ggplotGrob(an_sub), 
 #                          xmin = 5400000, xmax = 6600000, 
 #                          ymin = 2950000, ymax = 4150000)
# - https://ikashnitsky.github.io/2017/subplots-in-maps/



if(interactive()){
  ggsave("inst/manuscript_v2/Figure3-Chronic.png",width = 12,height=8,dpi=300)
}



```

-[ ] take the same stations as in Excluded Metals.

```{r}
site.year <- driverdata%>%filter(Exclusion.CAS=="Excluded_Metals_PAH",test=="Chronic") %>% group_by(LOQ.type)%>% nest()%>%mutate(sy=map(data,function(df)unique(df$Site.Year)))
## extract driver data with the same site.year.

currentdat <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0", "LOQ.T1"),
Exclusion.CAS = c("Current_Use"),Data.SSD.1, threshold=0.1)
currentdat <- currentdat %>% filter(test=="Chronic")
tmp1 <- currentdat %>% filter(LOQ.type=="LOQ.T0") %>% filter(Site.Year %in% site.year$sy[[1]])
tmp2 <- currentdat %>% filter(LOQ.type=="LOQ.T1") %>% filter(Site.Year %in% site.year$sy[[2]])
currentdat1 <- rbind(tmp1,tmp2)%>%group_by(LOQ.type) %>% nest()%>% mutate(data=purrr::map(data,function(df){
  df1<- df%>%group_by(Site.Year,monitoringSiteIdentifier,phenomenonTimeReferenceYear,HI) %>% nest()
  df <- df1[order(df1$HI,decreasing = T),]%>% add_column(x=1:nrow(df1))%>%unnest(cols = c(data))%>% ungroup
  return(df)}))%>%unnest(cols = c(data))%>%mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))
```


- Generate Table 13: Substances driving the cumulative risks for each of the mixture groups in the Rhine dataset under the more realistic scenario 

```{r}
driverdata1 %>% left_join(Res)%>% group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic) %>% summarise(N=length(unique(Site.Year)))
```


```{r}
chemclass <- chemclass %>% mutate(CAS=as.character(CAS))
table13 <- driverdata1 %>% left_join(Res)%>% group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic) %>% mutate(N=length(unique(Site.Year))) %>% filter(Component!="All Other")%>% group_by(LOQ.type, Exclusion.CAS,Group_AF1_Chronic,N,CAS) %>% summarise(HQmax=max(HQ,na.rm=T),N1=sum(HQ>1,na.rm=T),N2=sum(HQ>0.5,na.rm = T),N3=sum(HQ>0.1)) %>% filter((Group_AF1_Chronic=="I" & N1>0) | (Group_AF1_Chronic=="IIIA" & N2>0) | (Group_AF1_Chronic=="IIIB" & N3>0)) %>% left_join(chemclass) %>% dplyr::select(c('LOQ.type', 'Exclusion.CAS', 'Group_AF1_Chronic', 'N',"Substance","HQmax","N1","N2","N3"))
```


```{r}
write.csv(table13,file="inst/manuscript_v2/table13.csv")
```


```{r}
table13%>% knitr::kable(.,format = "html")%>%kableExtra::collapse_rows(.,columns = 1:4)
```


- assemble the driver dataset with data from same sampling sites/stations
- Filter by HI>1 *** Note this was added after the email on 7/13 from Ismael

```{r}
driverdata2 <- rbind(driverdata1 %>% filter(Exclusion.CAS=="Excluded_Metals_PAH" & test=="Chronic"),currentdat1)
driverdata2 <- driverdata2 %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))%>%filter(HI>0.1)


nsample2 <- driverdata2 %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))
```

- Genera Figure 3


```{r}
detach("package:plyr")
sumdriver1 <- driverdata1 %>% group_by(LOQ.type,Exclusion.CAS,test,Site.Year) %>% mutate(sumHQ=sum(HQ))%>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test,Component,Site.Year) %>% summarise(Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

p1 <- ggplot(sumdriver1%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS)+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))
p1
if(interactive()){
ggsave("inst/manuscript_v2/Figure3-Chronic-boxplot-sqrt.png",width = 12,height=8,dpi=300)
}
ggplot(sumdriver1%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.01))
if(interactive()){
ggsave("inst/manuscript_v2/Figure3-Chronic-boxplot.png",width = 12,height=8,dpi=300)
}
```





```{r eval=T}

pbar2 <- ggplot(driverdata2%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample2 %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)+xlab("")+theme(legend.position = "bottom")

                                                                                                                                                                                                                                                                                                      
## A function to plot the inset 
get_inset <- function(sumdriver){
  p <- ggplot(data=sumdriver %>% filter(test=="Chronic") %>% 
                group_by(LOQ.type,Exclusion.CAS),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=9) +  ## makes everything smaller
    scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(0.7)), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
  return(p)
}


## This function allows us to specify which facet to annotate
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}


### The first method does not generate proper anchor for the annotation. we keep the code here for revisiting later  
insets <- plyr::dlply(sumdriver1 %>% filter(test=="Chronic"), c("LOQ.type", "Exclusion.CAS"), function(d){
  annotation_custom2(grob = ggplotGrob(
    get_inset(d)
  ), 
                     data = data.frame(x=1000, HQ=max(d$Perc), 
                                       LOQ.type=unique(d$LOQ.type), 
                                       Exclusion.CAS=unique(d$Exclusion.CAS)), 
                     xmin=1000, xmax=3500, ymin=-Inf, ymax=0.3)
})


inset_plot <- NULL
## tmp <- expand.grid(LOQ.type = c("LOQ.T0","LOQ.T1"),Exclusion.CAS = c("Excluded_Metals_PAH","Current_Use"))
for(i in 1:2)
  for(j in 1:2){
    inset_plot[[2*(i-1)+j]] <- NA
  }

names(inset_plot) <- paste0(nsample2$LOQ.type,"-",nsample2$Exclusion.CAS)

for (LOQ in c("LOQ.T0","LOQ.T1")) {
 for(Exclusion in c("Excluded_Metals_PAH","Current_Use")){
     p <- ggplot(data=sumdriver2 %>% filter(test=="Chronic" & Exclusion.CAS==Exclusion & LOQ.type==LOQ),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=12) +  ## makes everything smaller
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(1),angle = 45,hjust=1,vjust=1), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
     
     inset_plot[[paste0(LOQ,"-",Exclusion)]] <- p
 } 
}



pbar2+annotation_custom2(grob = ggplotGrob(inset_plot[[1]]), data = data.frame(x=nsample2$sy[1], HQ=150, 
                                       LOQ.type=nsample2$LOQ.type[1], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[1]),
                         xmin = nsample2$sy[1]*0.15, xmax = nsample2$sy[1]*0.95, ymin = 2.5, ymax =nsample2$hmax[1]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[2]]), data = data.frame(x=nsample2$sy[2], HQ=nsample2$hmax[2]*0.95,                                        LOQ.type=nsample2$LOQ.type[2], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[2]),
                         xmin = nsample2$sy[2]*0.15, xmax = nsample2$sy[2]*0.95, ymin = 25, ymax =nsample2$hmax[2]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[3]]), data = data.frame(x=nsample2$sy[3], HQ=13,                                        LOQ.type=nsample2$LOQ.type[3], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[3]),
                         xmin = nsample2$sy[3]*0.15, xmax = nsample2$sy[3]*0.95, ymin = 0.05, ymax =nsample2$hmax[3]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[4]]), data = data.frame(x=nsample2$sy[4], HQ=60,                                       LOQ.type=nsample2$LOQ.type[4], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[4]),
                         xmin = nsample2$sy[4]*0.15, xmax = nsample2$sy[4]*0.95, ymin = 0.25, ymax =nsample2$hmax[4]*0.95)


# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_v2/Figure3-Chronic-annotated.png",width = 12,height=8,dpi=300)
}
```


```{r}
inset_plot <- NULL
## tmp <- expand.grid(LOQ.type = c("LOQ.T0","LOQ.T1"),Exclusion.CAS = c("Excluded_Metals_PAH","Current_Use"))
for(i in 1:2)
  for(j in 1:2){
    inset_plot[[2*(i-1)+j]] <- NA
  }

names(inset_plot) <- paste0(nsample2$LOQ.type,"-",nsample2$Exclusion.CAS)

for (LOQ in c("LOQ.T0","LOQ.T1")) {
 for(Exclusion in c("Excluded_Metals_PAH","Current_Use")){
     p <- ggplot(data=sumdriver2 %>% filter(test=="Chronic" & Exclusion.CAS==Exclusion & LOQ.type==LOQ),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=12) +  ## makes everything smaller
    scale_y_sqrt(labels = scales::percent_format(accuracy = 1))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(1),angle = 45,hjust=1,vjust=1), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
     
     inset_plot[[paste0(LOQ,"-",Exclusion)]] <- p
 } 
}


pbar2+annotation_custom2(grob = ggplotGrob(inset_plot[[1]]), data = data.frame(x=nsample2$sy[1], HQ=150, 
                                       LOQ.type=nsample2$LOQ.type[1], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[1]),
                         xmin = nsample2$sy[1]*0.15, xmax = nsample2$sy[1]*0.95, ymin = 2.5, ymax =nsample2$hmax[1]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[2]]), data = data.frame(x=nsample2$sy[2], HQ=nsample2$hmax[2]*0.95,                                        LOQ.type=nsample2$LOQ.type[2], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[2]),
                         xmin = nsample2$sy[2]*0.15, xmax = nsample2$sy[2]*0.95, ymin = 25, ymax =nsample2$hmax[2]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[3]]), data = data.frame(x=nsample2$sy[3], HQ=13,                                        LOQ.type=nsample2$LOQ.type[3], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[3]),
                         xmin = nsample2$sy[3]*0.15, xmax = nsample2$sy[3]*0.95, ymin = 0.05, ymax =nsample2$hmax[3]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[4]]), data = data.frame(x=nsample2$sy[4], HQ=60,                                       LOQ.type=nsample2$LOQ.type[4], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[4]),
                         xmin = nsample2$sy[4]*0.15, xmax = nsample2$sy[4]*0.95, ymin = 0.25, ymax =nsample2$hmax[4]*0.95)


# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_v2/Figure3-Chronic-annotated-sqrt.png",width = 12,height=8,dpi=300)
}
```


#### Figure 3 Chronic with same site and year as in the Excluded_Metals_PAH


```{r}
driverdata2 <- rbind(driverdata1 %>% filter(Exclusion.CAS=="Excluded_Metals_PAH" & test=="Chronic"),currentdat1)
driverdata2 <- driverdata2 %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))%>%filter(HI>0.1)


nsample2 <- driverdata2 %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest()%>%mutate(sy=map(data,function(df) length(unique(df$Site.Year))),hmax=map(data,function(df) max(df$HI)))%>% select(-data) %>% unnest(cols=c(sy,hmax)) %>% mutate(Exclusion.CAS=factor(Exclusion.CAS,levels=c("Excluded_Metals_PAH","Current_Use")))
```

```{r}
sumdriver2 <- driverdata2 %>% group_by(LOQ.type,Exclusion.CAS,test,Site.Year) %>% mutate(sumHQ=sum(HQ))%>% ungroup %>% group_by(LOQ.type,Exclusion.CAS,test,Component,Site.Year) %>% summarise(Perc=HQ/sumHQ) %>% mutate(Component=factor(Component,levels=c("Driver 1","Driver 2","Driver 3","All Other" )))

library(scales)
ggplot(sumdriver2%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))
if(interactive()){
ggsave("inst/manuscript_v2/Figure3-Chronic-boxplot-Chronic-Site.Year-sqrt.png",width = 12,height=8,dpi=300)
}

ggplot(sumdriver2%>%filter(test=="Chronic"),aes(x=Component,y=Perc))+geom_boxplot(aes(fill=Component))+facet_grid(LOQ.type~Exclusion.CAS,scale="free")+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_y_continuous(labels = scales::percent_format(accuracy = 0.01))
if(interactive()){
ggsave("inst/manuscript_v2/Figure3-Chronic-boxplot-Chronic-Site.Year.png",width = 12,height=8,dpi=300)
}
```





```{r eval=T}

pbar2 <- ggplot(driverdata2%>%filter(test=="Chronic"),aes(x=x,y=HQ))+geom_bar(aes(fill=Component,col=Component),position=position_stack(reverse = T),stat = "identity")+facet_wrap(LOQ.type~Exclusion.CAS,scale="free")+ theme(axis.text.x = element_blank(), axis.ticks = element_blank())+geom_text(data=nsample2 %>% filter(test=="Chronic"),aes(x=sy,y=hmax,label=paste0("N.Sample = ",sy)),hjust=1)+xlab("")+theme(legend.position = "bottom")

                                                                                                                                                                                                                                                                                                      
## A function to plot the inset 
get_inset <- function(sumdriver){
  p <- ggplot(data=sumdriver %>% filter(test=="Chronic") %>% 
                group_by(LOQ.type,Exclusion.CAS),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=9) +  ## makes everything smaller
    scale_y_sqrt(labels = scales::percent_format(accuracy = 0.01))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(0.7)), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
  return(p)
}


## This function allows us to specify which facet to annotate
annotation_custom2 <- function (grob, xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = Inf, data) 
{
  layer(data = data, stat = StatIdentity, position = PositionIdentity, 
        geom = ggplot2:::GeomCustomAnn,
        inherit.aes = TRUE, params = list(grob = grob, 
                                          xmin = xmin, xmax = xmax, 
                                          ymin = ymin, ymax = ymax))
}


### The first method does not generate proper anchor for the annotation. we keep the code here for revisiting later  
insets <- plyr::dlply(sumdriver1 %>% filter(test=="Chronic"), c("LOQ.type", "Exclusion.CAS"), function(d){
  annotation_custom2(grob = ggplotGrob(
    get_inset(d)
  ), 
                     data = data.frame(x=1000, HQ=max(d$Perc), 
                                       LOQ.type=unique(d$LOQ.type), 
                                       Exclusion.CAS=unique(d$Exclusion.CAS)), 
                     xmin=1000, xmax=3500, ymin=-Inf, ymax=0.3)
})


inset_plot <- NULL
## tmp <- expand.grid(LOQ.type = c("LOQ.T0","LOQ.T1"),Exclusion.CAS = c("Excluded_Metals_PAH","Current_Use"))
for(i in 1:2)
  for(j in 1:2){
    inset_plot[[2*(i-1)+j]] <- NA
  }

names(inset_plot) <- paste0(nsample2$LOQ.type,"-",nsample2$Exclusion.CAS)

for (LOQ in c("LOQ.T0","LOQ.T1")) {
 for(Exclusion in c("Excluded_Metals_PAH","Current_Use")){
     p <- ggplot(data=sumdriver2 %>% filter(test=="Chronic" & Exclusion.CAS==Exclusion & LOQ.type==LOQ),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=12) +  ## makes everything smaller
    scale_y_continuous(labels = scales::percent_format(accuracy = 1))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(1),angle = 45,hjust=1,vjust=1), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
     
     inset_plot[[paste0(LOQ,"-",Exclusion)]] <- p
 } 
}



pbar2+annotation_custom2(grob = ggplotGrob(inset_plot[[1]]), data = data.frame(x=nsample2$sy[1], HQ=150, 
                                       LOQ.type=nsample2$LOQ.type[1], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[1]),
                         xmin = nsample2$sy[1]*0.15, xmax = nsample2$sy[1]*0.95, ymin = 2.5, ymax =nsample2$hmax[1]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[2]]), data = data.frame(x=nsample2$sy[2], HQ=nsample2$hmax[2]*0.95,                                        LOQ.type=nsample2$LOQ.type[2], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[2]),
                         xmin = nsample2$sy[2]*0.15, xmax = nsample2$sy[2]*0.95, ymin = 25, ymax =nsample2$hmax[2]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[3]]), data = data.frame(x=nsample2$sy[3], HQ=13,                                        LOQ.type=nsample2$LOQ.type[3], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[3]),
                         xmin = nsample2$sy[3]*0.15, xmax = nsample2$sy[3]*0.95, ymin = 0.05, ymax =nsample2$hmax[3]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[4]]), data = data.frame(x=nsample2$sy[4], HQ=60,                                       LOQ.type=nsample2$LOQ.type[4], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[4]),
                         xmin = nsample2$sy[4]*0.15, xmax = nsample2$sy[4]*0.95, ymin = 0.25, ymax =nsample2$hmax[4]*0.95)


# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_v2/Figure3-Chronic-annotated-site-year.png",width = 12,height=8,dpi=300)
}
```


```{r}
inset_plot <- NULL
## tmp <- expand.grid(LOQ.type = c("LOQ.T0","LOQ.T1"),Exclusion.CAS = c("Excluded_Metals_PAH","Current_Use"))
for(i in 1:2)
  for(j in 1:2){
    inset_plot[[2*(i-1)+j]] <- NA
  }

names(inset_plot) <- paste0(nsample2$LOQ.type,"-",nsample2$Exclusion.CAS)

for (LOQ in c("LOQ.T0","LOQ.T1")) {
 for(Exclusion in c("Excluded_Metals_PAH","Current_Use")){
     p <- ggplot(data=sumdriver2 %>% filter(test=="Chronic" & Exclusion.CAS==Exclusion & LOQ.type==LOQ),
              aes(x=Component,y=Perc,fill=Component))+
    geom_boxplot()  + 
    guides(fill=FALSE) +
    theme_bw(base_size=12) +  ## makes everything smaller
    scale_y_sqrt(labels = scales::percent_format(accuracy = 1))+
    theme(panel.background = element_rect(fill="white"),  ## white plot background 
          axis.title.y = element_blank(),
          axis.title.x = element_blank(),
          axis.text.x = element_text(size=rel(1),angle = 45,hjust=1,vjust=1), ## tiny axis text
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.background = element_blank())
     
     inset_plot[[paste0(LOQ,"-",Exclusion)]] <- p
 } 
}


pbar2+annotation_custom2(grob = ggplotGrob(inset_plot[[1]]), data = data.frame(x=nsample2$sy[1], HQ=150, 
                                       LOQ.type=nsample2$LOQ.type[1], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[1]),
                         xmin = nsample2$sy[1]*0.15, xmax = nsample2$sy[1]*0.95, ymin = 2.5, ymax =nsample2$hmax[1]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[2]]), data = data.frame(x=nsample2$sy[2], HQ=nsample2$hmax[2]*0.95,                                        LOQ.type=nsample2$LOQ.type[2], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[2]),
                         xmin = nsample2$sy[2]*0.15, xmax = nsample2$sy[2]*0.95, ymin = 25, ymax =nsample2$hmax[2]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[3]]), data = data.frame(x=nsample2$sy[3], HQ=13,                                        LOQ.type=nsample2$LOQ.type[3], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[3]),
                         xmin = nsample2$sy[3]*0.15, xmax = nsample2$sy[3]*0.95, ymin = 0.05, ymax =nsample2$hmax[3]*0.95)+
  annotation_custom2(grob = ggplotGrob(inset_plot[[4]]), data = data.frame(x=nsample2$sy[4], HQ=60,                                       LOQ.type=nsample2$LOQ.type[4], 
                                       Exclusion.CAS=nsample2$Exclusion.CAS[4]),
                         xmin = nsample2$sy[4]*0.15, xmax = nsample2$sy[4]*0.95, ymin = 0.25, ymax =nsample2$hmax[4]*0.95)


# - https://ikashnitsky.github.io/2017/subplots-in-maps/


# https://www.blopig.com/blog/2019/08/combining-inset-plots-with-facets-using-ggplot2/
if(interactive()){
  ggsave("inst/manuscript_v2/Figure3-Chronic-annotated-sqrt-site-year.png",width = 12,height=8,dpi=300)
}
```



### Figure 4a (barplot)

Figure 4. Main risk drivers 

There are two potential options for this plot 

- Option 1 (geom_bar):  

- Building on the same approach used in Figure 3. We investigate only the chemicals that appear more frequently among the first, second or third risk drivers for the Station_Year observations with HI > 0.1. 

- Pros: We build on previous analysis, and focus only in the chemicals that are most relevant for stations with the larger His. 
- Cons: Does not provide a more general assessment across all chemicals of those that could be of potential relevance (independently on whether they appear or not very frequently in the most risky mixtures). The frequency of appearance depends on (1) concentration (2) frequency of monitoring. This is uncaptured by this analysis. 

Plot: 

- Chronic, identical plot for acute for SM. 
- Frequency (%) as first, second or third component ~ CAS 
- Faceting: (1 x 2) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals_PAH") 
- Color by Percentile (as is now) 

- [x] only chronic
- [x] color axis tick label by chemical groups


```{r}
sumCAS <- driverdata %>% filter(HI>1) %>% group_by(LOQ.type,Exclusion.CAS,test)%>%mutate(nSample=length(unique(Site.Year))) %>% group_by(LOQ.type,Exclusion.CAS,test,CAS,nSample) %>%nest() %>% mutate(nappear=purrr::map(data,nrow))%>% unnest(cols=c(nappear))%>% mutate(freq=nappear/nSample ) %>% select(-data) %>% group_by(LOQ.type,Exclusion.CAS,test)%>% nest() %>% mutate(data=purrr::map(data,function(df){
  df <- df[order(df$freq,decreasing = T),]
  df <- df%>%add_column(x=1:nrow(df))
  return(df)
}))%>%unnest(cols = c(data))%>%ungroup #%>% mutate(x=paste0(x,"-",CAS))

sumCAS <- sumCAS %>% left_join(chemclass[,c("CAS","Substance","Chem.Group","class")]%>%mutate(CAS=as.character(CAS)))%>%filter(CAS!="")%>% filter(x<=41) 
```

```{r}
write.csv(sumCAS,file="inst/manuscript_v2/table_fig4a.csv")
```


- generate figure 4a

```{r}
sumCAS <- sumCAS%>% mutate(Sub1=paste0(x,freq,"*",Substance)) %>% mutate(Sub1=factor(Sub1,levels=rev(unique(Sub1))))


color = c(Current_Use = "#2596be", Banned_Listed = "#f28e2b", Metal = "#e15759")
library(ggtext)
library(glue)
labels <- data.frame(Substance=str_split(levels(sumCAS$Sub1),"\\*",simplify=T)[,2]) %>% left_join(chemclass[,c("Substance","class")]) %>%mutate(Sub2= glue("<i style='color: {color[class]}'>{Substance}</i>")) 


library(ggtext)
ggplot(sumCAS%>%filter(Exclusion.CAS=="Excluded_Metals_PAH" &test=="Chronic"),aes(x=Sub1,y=freq,fill=Chem.Group))+geom_bar(stat="identity")+ coord_flip()+facet_wrap(~LOQ.type,scale="free",drop=TRUE)+scale_x_discrete(breaks=levels(sumCAS$Sub1),label=labels$Sub2)+scale_y_continuous(labels = scales::percent_format(accuracy = 1))+xlab("")+  theme(axis.text.x = element_markdown(),axis.text.y = element_markdown(),legend.position = "bottom")+ylab("Frequency in top 3 drivers")

#ggplot(sumCAS%>%filter(Exclusion.CAS=="Excluded_Metals_PAH" & test=="Acute"&LOQ.type=="LOQ.T0"),aes(x=reorder(Substance,freq),y=freq,fill=Chem.Group))+geom_bar(stat="identity")+ coord_flip()+facet_wrap(LOQ.type~test,scale="free",drop=TRUE)
if(interactive()){
  ggsave("inst/manuscript_v2/Figure4a-Chronic.png",width = 12,height=8,dpi=300)
}
```


```{r}
ggplot(sumCAS%>%filter(Exclusion.CAS=="Current_Use" &test=="Chronic"),aes(x=Sub1,y=freq,fill=Chem.Group))+geom_bar(stat="identity")+ coord_flip()+facet_wrap(~LOQ.type,scale="free",drop=TRUE)+scale_x_discrete(breaks=levels(sumCAS$Sub1),label=labels$Sub2)+scale_y_continuous(labels = scales::percent_format(accuracy = 1))+xlab("")+  theme(axis.text.x = element_markdown(),axis.text.y = element_markdown(),legend.position = "bottom")+ylab("Frequency in top 3 drivers")

#ggplot(sumCAS%>%filter(Exclusion.CAS=="Excluded_Metals_PAH" & test=="Acute"&LOQ.type=="LOQ.T0"),aes(x=reorder(Substance,freq),y=freq,fill=Chem.Group))+geom_bar(stat="identity")+ coord_flip()+facet_wrap(LOQ.type~test,scale="free",drop=TRUE)
if(interactive()){
  ggsave("inst/manuscript_v2/Figure4a-Chronic-Current_Use.png",width = 12,height=8,dpi=300)
}
```


### Figure 4b (dotplot)

Option 2 (geom_point): 

We approach the relevance as HQ quantiles per CAS. Quantiles P95, P75, P50, P25, ordered by P95. We explore the frequency in which each CAS is found at RQ levels of reference (RQ = 0.01, 0.1, 1). Only the chemicals found beyond certain level, at certain frequency can have probability of being relevant overall for the mixtures. 

- Pros: Explore in a more detail way the potential contribution of all CAS to overall risk. Further, information on the frequency of monitoring and detection, and LOQs can be easily added to the plot for enhance transparency and interpretation. 
- Cons: Not directly linked to previous analysis (Figure 3). A little less direct to link single chemical relevance to "mixture effects". 

Plot: 

- Chronic, identical plot for acute for SM. 
- HQ ~ CAS (for Quantiles P95, P75, P50, P25, ordered by P95) 
- @Zhenglei. To add min(LOQ) per CAS to the plot with a different symbol 
- Faceting: (1 x 2) 
- LOQ.type = c("LOQ.T0", "LOQ.T1") 
- Exclusion.CAS = c("Excluded_Metals_PAH") 
- Color by "Chem.Group (Metal, Industrial, PAH, Pharma, Pesticide) 

- [x] color axis tick label by chemical groups
- [x] add number of sites and samples with this CAS. 

```{r}
casdata <- getCasData(Data.AggBySiteID.2,chemclass,Data.SSD.1)
```


```{r}
#driverdata <- getDriverData(Data.AggBySiteID.2,chemclass,LOQ.type = c("LOQ.T0", "LOQ.T1"), Exclusion.CAS = c("Excluded_Metals_PAH", "Current_Use"), Data.SSD.1,include0 = T)
HQdata <- getHQData_Chronic(Data.AggBySiteID.2,chemclass=chemclass,Data.SSD.1=Data.SSD.1,LOQ.type= c("LOQ.T0", "LOQ.T1"),driverdata,Exclusion.CAS="Excluded_Metals_PAH")
```


```{r}
sumCAS <- HQdata %>% mutate(test="Chronic") %>%group_by(LOQ.type,test)%>%mutate(nSample=length(unique(Site.Year))) %>% group_by(LOQ.type,test,CAS,nSample) %>%nest() %>% mutate(nappear=purrr::map(data,nrow),QI=purrr::map(data,function(df) quantile(df$HQ.Chronic,c(0.25,0.5,0.75,0.95,1))))%>% unnest(cols=c(nappear,QI))%>% mutate(freq=nappear/nSample ) %>% select(-data) %>% mutate(Quantile=c("25%","50%","75%","95%","100%"))%>% group_by(LOQ.type,test,CAS)%>% mutate(q95=QI[Quantile=="95%"])%>% filter(q95>0.1)%>% group_by(LOQ.type,test)%>%nest()%>%mutate(data=purrr::map(data,function(df){
    df <- df %>% group_by(CAS,q95) %>% nest() 
    df <- df[order(df$q95),]
    df <- df %>% add_column(x=1:nrow(df))
    df <- df %>% unnest(cols=c(data))
    return(df)
}))%>%unnest(cols = c(data))%>%ungroup #%>% mutate(x=paste0(x,"-",CAS))

sumCAS <- sumCAS %>% left_join(casdata[,c("CAS","Substance","Chem.Group","Nmeasured","Ndetected","LOQ","LOQ.Chronic","LOQ.Acute")]%>%mutate(CAS=as.character(CAS)))%>%filter(CAS!="") %>% filter(x<=31)
```

```{r}
write.csv(sumCAS,file="inst/manuscript_v2/table_fig4b_Excluded_Metals_PAH.csv")
```


```{r}
sumCAS<- sumCAS%>%filter(Quantile!="100%")
sumCAS <- sumCAS%>%mutate(Sub1=paste0(x,"*",Substance)) %>% mutate(Sub1=factor(Sub1,levels=unique(Sub1)),Sub2=paste0(Sub1,"|",Nmeasured,"|",Ndetected))
## To add min(LOQ) per CAS to the plot with a different symbol 


## https://github.com/wilkelab/ggtext/issues/27
color = c(Current_Use = "#006400", Banned_Listed = "#696969", Metal = "#e15759")
library(ggtext)
labels <- data.frame(Substance=str_split(levels(sumCAS$Sub1),"\\*",simplify=T)[,2]) %>% left_join(casdata[,c("Substance","class","Nmeasured","Ndetected")])%>%mutate(Substance=paste0(Substance,"|",Nmeasured,"|",Ndetected)) %>%mutate(Sub2= glue::glue("<i style='background-color: {color[class]}'>{Substance}</i>")) %>% mutate(Sub3= glue::glue("<i style='color: {color[class]}'>{Substance}</i>"))



  
  
ggplot(sumCAS%>%filter( test=="Chronic"  ),aes(x=Sub1,y=QI,fill=Chem.Group))+geom_point(aes(col=Chem.Group,pch=Quantile))+ coord_flip()+facet_wrap(LOQ.type~test,scale="free",drop=TRUE)+scale_x_discrete(breaks=levels(sumCAS$Sub1),label=labels$Sub3)+xlab("")+  theme(axis.text.x = element_markdown(),axis.text.y = element_markdown(),legend.position = "bottom")+scale_y_log10()+ylab("HQ")##+geom_point(aes(y=LOQ.Chronic),pch="l")
if(interactive()){
  ggsave("inst/manuscript_v2/Figure4b-Chronic.png",width = 12,height=9,dpi=300)
}

```








```
> summary(Data.AggBySiteID.2$procedureLOQValue)
    Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
0.00e+00 0.00e+00 0.00e+00 7.33e+01 1.00e-01 1.00e+06 
> sum(Data.AggBySiteID.2$procedureLOQValue < Data.AggBySiteID.2$resultMeanValue)
[1] 99126
> sum(Data.AggBySiteID.2$procedureLOQValue < Data.AggBySiteID.2$resultMeanValue)/nrow(Data.AggBySiteID.2)
[1] 0.1599839
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMeanValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0.6066274
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])
[1] 0
> sum(Data.AggBySiteID.2$procedureLOQValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0
> sum(Data.AggBySiteID.2$AboveLOQ)
[1] 158252
> sum(Data.AggBySiteID.2$resultMeanValue[Data.AggBySiteID.2$AboveLOQ] < Data.AggBySiteID.2$resultMaxValue[Data.AggBySiteID.2$AboveLOQ])/sum(Data.AggBySiteID.2$AboveLOQ)
[1] 0

```

